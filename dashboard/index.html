<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin HC 32</title>

    <script src="../config.js"></script>
    <script src="../components.js"></script>

    <style>
        /* Variabel Lokal untuk Dashboard */
        :root {
            --db-bg: #f8fafc;
            --db-card-bg: #ffffff;
            --db-text-main: #1e293b;
            --db-text-sub: #64748b;
            --db-border: #e2e8f0;
        }

        /* Reset Main Container agar pas dengan Sidebar dari components.js */
        /* PENTING: Class 'dashboard-page' ini menghindari konflik style */
        body { background-color: var(--db-bg); }
        
        main {
            padding: 30px;
            margin-left: 260px; /* Memberi ruang untuk Sidebar */
            min-height: 100vh;
            transition: margin-left 0.3s;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            main { margin-left: 0; padding: 20px 15px; }
        }

        /* === HEADER HALAMAN === */
        .page-header { margin-bottom: 30px; }
        .page-title {
            font-size: 24px; font-weight: 700; color: var(--db-text-main); margin: 0;
        }
        .page-subtitle {
            font-size: 14px; color: var(--db-text-sub); margin-top: 5px;
        }

        /* === GRID LAYOUT === */
        .dashboard-grid {
            display: grid;
            /* Grid pintar: minimal lebar 300px, sisanya menyesuaikan */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px;
        }

        /* === CARD STYLE === */
        .db-card {
            background: var(--db-card-bg);
            border-radius: 16px;
            border: 1px solid var(--db-border);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header Kartu */
        .db-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid var(--db-border);
        }
        .db-card-title {
            font-size: 16px; font-weight: 600; color: var(--db-text-main);
            display: flex; align-items: center; gap: 10px;
        }
        .db-card-title i {
            font-size: 18px; color: #1a4787; /* Biru HC */
            background: rgba(26, 71, 135, 0.1); padding: 8px; border-radius: 8px;
        }
        .db-view-link {
            font-size: 12px; font-weight: 500; color: #1a4787; text-decoration: none;
            padding: 6px 12px; background: #f0f9ff; border-radius: 20px;
        }
        .db-view-link:hover { background: #1a4787; color: #fff; }

        /* List Items */
        .db-list {
            display: flex; flex-direction: column; gap: 15px;
            max-height: 320px; overflow-y: auto; /* Scroll jika panjang */
        }
        
        .db-item {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 8px; border-radius: 8px; transition: 0.2s;
        }
        .db-item:hover { background: #f8fafc; }

        /* Avatar/Icon Item */
        .item-img {
            width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
            border: 1px solid var(--db-border); flex-shrink: 0;
        }
        .item-icon-placeholder {
            width: 42px; height: 42px; border-radius: 50%; 
            background: #e0f2fe; color: #0284c7;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; flex-shrink: 0;
        }

        /* Teks Item */
        .item-content { flex: 1; min-width: 0; }
        .item-main-text {
            font-size: 14px; font-weight: 600; color: var(--db-text-main);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item-sub-text {
            font-size: 12px; color: var(--db-text-sub); margin-top: 2px;
            line-height: 1.4;
        }
        .item-date {
            font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 4px; margin-top: 4px;
        }

        /* Pesan Kosong */
        .empty-state {
            text-align: center; color: #94a3b8; font-size: 13px; font-style: italic; padding: 20px 0;
        }
    </style>
</head>
<body>

    <main>
        <div class="page-header">
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Selamat datang, <span id="admin-name-span">Pengurus</span>!</p>
        </div>

        <div class="dashboard-grid">

            <div class="db-card">
                <div class="db-card-header">
                    <div class="db-card-title"><i class="ri-fingerprint-line"></i> Presensi</div>
                    <a href="../presensi/" class="db-view-link">Semua</a>
                </div>
                <div id="list-presensi" class="db-list">
                    <div class="empty-state">Memuat data...</div>
                </div>
            </div>

            <div class="db-card">
                <div class="db-card-header">
                    <div class="db-card-title"><i class="ri-group-line"></i> Anggota Baru</div>
                    <a href="../anggota/" class="db-view-link">Semua</a>
                </div>
                <div id="list-anggota" class="db-list">
                    <div class="empty-state">Memuat data...</div>
                </div>
            </div>

            <div class="db-card">
                <div class="db-card-header">
                    <div class="db-card-title"><i class="ri-calendar-event-line"></i> Agenda</div>
                    <a href="../agenda/" class="db-view-link">Semua</a>
                </div>
                <div id="list-agenda" class="db-list">
                    <div class="empty-state">Memuat data...</div>
                </div>
            </div>

            <div class="db-card">
                <div class="db-card-header">
                    <div class="db-card-title"><i class="ri-article-line"></i> Postingan</div>
                    <a href="../posting/" class="db-view-link">Semua</a>
                </div>
                <div id="list-posting" class="db-list">
                    <div class="empty-state">Memuat data...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // === LOGIKA JAVASCRIPT ===
        
        let ADMIN_TOKEN = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Render Sidebar & Header (dari components.js)
            initHC32AdminNavigation('dashboard');

            // 2. Cek Login
            if (cekSesi()) {
                // 3. Ambil Data
                window.showHC32Status('loading', 'Sinkronisasi...', 'Mengambil data terbaru.');
                ambilDataDashboard().finally(() => window.hideHC32Status());
            }
        });

        // --- FUNGSI CEK SESI ---
        function cekSesi() {
            const params = new URLSearchParams(window.location.search);
            const t = params.get('token');
            const n = params.get('n');
            const j = params.get('j');
            const f = params.get('f');

            let session = null;

            // Jika ada di URL (baru login), simpan
            if (t && n) {
                hc32_saveSession(t, n, j, f);
                window.history.replaceState({}, document.title, window.location.pathname);
                session = { token: t, nama: n };
            } else {
                // Cek storage
                session = hc32_getSession();
            }

            if (!session || !session.token) {
                alert("Sesi habis. Login kembali.");
                window.location.href = "../../keanggotaan/login pengurus/index.html";
                return false;
            }

            ADMIN_TOKEN = session.token;
            document.getElementById('admin-name-span').textContent = session.nama || 'Pengurus';
            return true;
        }

        // --- FUNGSI AMBIL DATA ---
        async function ambilDataDashboard() {
            try {
                // Request paralel agar cepat
                const [dPresensi, dAnggota, dAgenda, dPosting] = await Promise.all([
                    hc32_post("getPresensiDashboard", { token: ADMIN_TOKEN }),
                    hc32_post("listAnggotaAdmin", { token: ADMIN_TOKEN }),
                    hc32_post("listKegiatanAdmin", { token: ADMIN_TOKEN }),
                    hc32_post("listPostingAdmin", { token: ADMIN_TOKEN })
                ]);

                renderPresensi(dPresensi?.data);
                renderAnggota(dAnggota?.data);
                renderAgenda(dAgenda?.data);
                renderPosting(dPosting?.data);

            } catch (error) {
                console.error(error);
                window.showHC32Status('error', 'Gagal', 'Koneksi ke server bermasalah.');
            }
        }

        // --- FORMAT TANGGAL CANTIK (PERBAIKAN) ---
        function formatTanggal(str) {
            if (!str) return '-';
            const d = new Date(str);
            if (isNaN(d)) return str; // Jika bukan tanggal valid, kembalikan aslinya
            // Contoh: Senin, 12 Jan 2026
            return d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        }

        // --- FUNGSI RENDER (TAMPILAN) ---

        function renderPresensi(data) {
            const el = document.getElementById('list-presensi');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada data presensi.</div>'; return; }
            
            let html = '';
            data.slice(0, 5).forEach(x => {
                const inisial = x.nama ? x.nama.charAt(0) : '?';
                const img = x.foto ? `<img src="${x.foto}" class="item-img">` : `<div class="item-icon-placeholder">${inisial}</div>`;
                const tgl = formatTanggal(x.timestamp); // Format tanggal diperbaiki

                html += `
                <div class="db-item">
                    ${img}
                    <div class="item-content">
                        <div class="item-main-text">${x.nama}</div>
                        <div class="item-sub-text">${x.pertemuan || 'Pertemuan'} • ${x.jam || ''}</div>
                        <div class="item-date"><i class="ri-calendar-line"></i> ${tgl}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderAnggota(data) {
            const el = document.getElementById('list-anggota');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada anggota.</div>'; return; }
            
            // Urutkan dari yang terbaru (berdasarkan posisi array reverse atau timestamp)
            // Asumsi data dari backend sudah urut atau kita ambil dari bawah
            const sorted = data.reverse(); 

            let html = '';
            sorted.slice(0, 5).forEach(x => {
                const inisial = x.nama ? x.nama.charAt(0) : '?';
                const img = x.foto ? `<img src="${x.foto}" class="item-img">` : `<div class="item-icon-placeholder">${inisial}</div>`;
                
                html += `
                <div class="db-item">
                    ${img}
                    <div class="item-content">
                        <div class="item-main-text">${x.nama}</div>
                        <div class="item-sub-text">${x.kelas || x.tipe} • ID: ${x.id_hc || '-'}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderAgenda(data) {
            const el = document.getElementById('list-agenda');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Tidak ada agenda.</div>'; return; }

            const today = new Date(); today.setHours(0,0,0,0);
            const upcoming = data.filter(d => new Date(d.tanggal) >= today && d.status !== 'draft').sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

            if(upcoming.length === 0) { el.innerHTML = '<div class="empty-state">Tidak ada agenda terdekat.</div>'; return; }

            let html = '';
            upcoming.slice(0, 5).forEach(x => {
                const tgl = formatTanggal(x.tanggal);
                html += `
                <div class="db-item">
                    <div class="item-icon-placeholder" style="background:#fff7ed; color:#ea580c; border-radius:8px;">
                        <i class="ri-calendar-check-line" style="font-size:18px;"></i>
                    </div>
                    <div class="item-content">
                        <div class="item-main-text">${x.judul}</div>
                        <div class="item-sub-text">${tgl} • ${x.waktu}</div>
                        <div class="item-date"><i class="ri-map-pin-line"></i> ${x.tempat}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderPosting(data) {
            const el = document.getElementById('list-posting');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada postingan.</div>'; return; }

            let html = '';
            // Urutkan tanggal terbaru
            const sorted = data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            sorted.slice(0, 5).forEach(x => {
                const img = x.gambar ? `<img src="${x.gambar}" class="item-img" style="border-radius:8px;">` : 
                    `<div class="item-icon-placeholder" style="border-radius:8px; background:#f0fdf4; color:#16a34a;"><i class="ri-article-line"></i></div>`;
                const tgl = formatTanggal(x.tanggal);

                html += `
                <div class="db-item">
                    ${img}
                    <div class="item-content">
                        <div class="item-main-text">${x.judul}</div>
                        <div class="item-sub-text">${x.kategori}</div>
                        <div class="item-date"><i class="ri-time-line"></i> ${tgl}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

    </script>
</body>
</html>
