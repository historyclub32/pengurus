<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin HC 32</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">
    
    <script src="../config.js"></script>
    <script src="../components.js"></script>

    <style>
        :root {
            --hc-blue: #1a4787;
            --hc-toska: #0f8a94;
            --hc-dark: #2e2e2e;
            --hc-green: #15a256;
            --hc-red: #d30e14;
            --hc-blue-light-bg: rgba(26, 71, 135, 0.08);
        }

        /* Container Halaman Admin (Wajib ada karena Sidebar component) */
        main {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            margin-left: 260px; /* Sesuai lebar sidebar di components.js */
            min-height: 100vh;
            background-color: #f8fafc;
        }

        /* Responsif Sidebar (Mobile) */
        @media (max-width: 900px) {
            main { margin-left: 0; padding: 20px 16px; }
        }

        /* HEADER PAGE */
        .page-header {
            margin-bottom: 24px;
        }
        .page-title {
            font-size: 24px; font-weight: 700;
            color: var(--hc-dark); margin: 0 0 4px 0;
        }
        .page-subtitle { font-size: 14px; color: #64748b; margin: 0; }

        /* GRID DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* CONTENT CARDS */
        .content-section {
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--hc-dark);
            margin: 0 0 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        .section-title a {
            font-size: 12px;
            font-weight: 500;
            color: var(--hc-blue);
            text-decoration: none;
        }
        .section-title a:hover { text-decoration: underline; }
        
        /* PREVIEW LIST STYLE */
        .preview-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 350px; /* Scrollable content */
            overflow-y: auto;
        }
        .preview-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }
        .preview-item:hover { background-color: #f8fafc; }

        .preview-item-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            background-color: var(--hc-blue-light-bg);
            color: var(--hc-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .preview-item-foto {
            width: 40px; height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
        }
        .preview-item-img-posting {
             width: 40px; height: 40px;
             border-radius: 8px;
             object-fit: cover;
             flex-shrink: 0;
             border: 1px solid #e2e8f0;
        }

        .preview-item-info { flex: 1; min-width: 0; }
        .preview-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--hc-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .preview-item-sub {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            white-space: normal;
        }
        .placeholder-text {
            font-size: 13px;
            color: #94a3b8;
            text-align: center;
            padding: 20px 0;
            font-style: italic;
        }
    </style>
</head>
<body>

    <main>
        <header class="page-header">
            <div>
                <h1 class="page-title">Dashboard Admin</h1>
                <p class="page-subtitle">Selamat datang kembali, <span id="welcome-name">Pengurus</span>!</p>
            </div>
        </header>

        <div class="dashboard-grid">
            
            <section class="content-section">
                <h2 class="section-title">
                    <span><i class="ri-fingerprint-line" style="margin-right:8px; vertical-align:middle;"></i>Presensi Terbaru</span>
                    <a href="../presensi/">Lihat Semua</a>
                </h2>
                <div id="preview-presensi" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    <span><i class="ri-group-line" style="margin-right:8px; vertical-align:middle;"></i>Anggota Terbaru</span>
                    <a href="../anggota/">Lihat Semua</a>
                </h2>
                <div id="preview-anggota" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    <span><i class="ri-calendar-event-line" style="margin-right:8px; vertical-align:middle;"></i>Agenda Terdekat</span>
                    <a href="../agenda/">Lihat Semua</a>
                </h2>
                <div id="preview-agenda" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    <span><i class="ri-article-line" style="margin-right:8px; vertical-align:middle;"></i>Postingan Terbaru</span>
                    <a href="../posting/">Lihat Semua</a>
                </h2>
                <div id="preview-posting" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

        </div>
    </main>

    <script>
        // === INISIALISASI HALAMAN ADMIN ===
        document.addEventListener("DOMContentLoaded", () => {
            // Render Sidebar & Header
            initHC32AdminNavigation('dashboard');

            // Cek Sesi
            if (validateSession()) {
                // Tampilkan nama di subtitle
                document.getElementById('welcome-name').innerText = ADMIN_NAMA;
                
                // Tampilkan Loading Overlay (dari components.js)
                window.showHC32Status('loading', 'Memuat Data...', 'Mengambil ringkasan dashboard.');

                // Mulai muat data
                loadAllPreviews().finally(() => {
                    window.hideHC32Status(); // Tutup loading
                });
            }
        });

        // 1. Validasi Sesi
        let ADMIN_TOKEN = null;
        let ADMIN_NAMA = null;

        function validateSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlNama = urlParams.get('n');
            const urlJabatan = urlParams.get('j');
            const urlFoto = urlParams.get('f');

            let session;

            if (urlToken && urlNama) {
                console.log("Token dari URL");
                hc32_saveSession(urlToken, urlNama, urlJabatan, urlFoto);
                window.history.replaceState({}, document.title, window.location.pathname); 
                session = { token: urlToken, nama: urlNama, jabatan: urlJabatan, foto: urlFoto };
            } else {
                console.log("Token dari LocalStorage");
                session = hc32_getSession();
            }

            if (!session || !session.token || !session.nama) {
                alert("Sesi berakhir. Silakan login kembali.");
                // Redirect ke login (naik 2 level ke folder keanggotaan)
                window.location.href = "../../keanggotaan/login pengurus/index.html"; 
                return false;
            }

            ADMIN_TOKEN = session.token;
            ADMIN_NAMA = session.nama;
            return true;
        }

        // 2. Load Data Backend
        async function loadAllPreviews() {
            try {
                const [presensi, anggota, agenda, posting] = await Promise.all([
                    hc32_post("getPresensiDashboard", { token: ADMIN_TOKEN }),
                    hc32_post("listAnggotaAdmin", { token: ADMIN_TOKEN }),  
                    hc32_post("listKegiatanAdmin", { token: ADMIN_TOKEN }),  
                    hc32_post("listPostingAdmin", { token: ADMIN_TOKEN })   
                ]);

                // Render jika data valid
                renderPreviewPresensi(presensi?.data);
                renderPreviewAnggota(anggota?.data);
                renderPreviewAgenda(agenda?.data);
                renderPreviewPosting(posting?.data);

            } catch (err) {
                console.error("Gagal memuat dashboard:", err);
                // Jika token salah/expired, biasanya backend return error
                window.showHC32Status('error', 'Gagal Memuat', 'Terjadi kesalahan koneksi.');
            }
        }

        // 3. Render Functions
        function renderPreviewPresensi(data) {
            const container = document.getElementById("preview-presensi");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada presensi.</p>`; return;
            }
            container.innerHTML = "";
            data.slice(0, 5).forEach(p => { 
                const inisial = p.nama ? p.nama.charAt(0).toUpperCase() : 'HC';
                const fotoHTML = p.foto ? `<img src="${p.foto}" class="preview-item-foto">` : `<div class="preview-item-icon">${inisial}</div>`;
                
                container.innerHTML += `
                    <div class="preview-item">
                        ${fotoHTML}
                        <div class="preview-item-info">
                            <div class="preview-item-title">${p.nama}</div>
                            <div class="preview-item-sub">${p.pertemuan || '-'} • ${p.jam || '-'}</div>
                        </div>
                    </div>`;
            });
        }

        function renderPreviewAnggota(data) {
            const container = document.getElementById("preview-anggota");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada anggota.</p>`; return;
            }
            container.innerHTML = "";
            // Urutkan timestamp terbaru (jika ada timestamp)
            const sorted = data.sort((a,b) => (a.timestamp < b.timestamp) ? 1 : -1);
            
            sorted.slice(0, 5).forEach(p => {
                const inisial = p.nama ? p.nama.charAt(0).toUpperCase() : 'HC';
                const fotoHTML = p.foto ? `<img src="${p.foto}" class="preview-item-foto">` : `<div class="preview-item-icon">${inisial}</div>`;
                
                container.innerHTML += `
                    <div class="preview-item">
                        ${fotoHTML}
                        <div class="preview-item-info">
                            <div class="preview-item-title">${p.nama}</div>
                            <div class="preview-item-sub">ID: ${p.id_hc || '-'} • ${p.kelas || p.tipe}</div>
                        </div>
                    </div>`;
            });
        }

        function renderPreviewAgenda(data) {
            const container = document.getElementById("preview-agenda");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada agenda.</p>`; return;
            }
            container.innerHTML = "";
            const today = new Date(); today.setHours(0,0,0,0);
            
            // Filter agenda masa depan
            const upcoming = data
                .filter(p => new Date(p.tanggal) >= today && p.status !== 'draft')
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if(upcoming.length === 0) { container.innerHTML = `<p class="placeholder-text">Tidak ada agenda terdekat.</p>`; return; }

            upcoming.slice(0, 3).forEach(p => {
                const tgl = new Date(p.tanggal);
                const tglStr = tgl.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                
                container.innerHTML += `
                    <div class="preview-item">
                        <div class="preview-item-icon" style="border-radius:8px; font-size:12px;">${tgl.getDate()}</div>
                        <div class="preview-item-info">
                            <div class="preview-item-title">${p.judul}</div>
                            <div class="preview-item-sub">${tglStr} • ${p.waktu}</div>
                        </div>
                    </div>`;
            });
        }

        function renderPreviewPosting(data) {
            const container = document.getElementById("preview-posting");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada postingan.</p>`; return;
            }
            container.innerHTML = "";
            // Urutkan posting terbaru
            const sorted = data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            sorted.slice(0, 3).forEach(p => {
                const imgHTML = p.gambar ? `<img src="${p.gambar}" class="preview-item-img-posting">` : `<div class="preview-item-icon" style="border-radius:8px;"><i class="ri-article-line"></i></div>`;
                
                container.innerHTML += `
                    <div class="preview-item">
                        ${imgHTML}
                        <div class="preview-item-info">
                            <div class="preview-item-title">${p.judul}</div>
                            <div class="preview-item-sub">${p.kategori}</div>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
