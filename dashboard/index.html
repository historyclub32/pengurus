<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Admin HC 32</title>

    <script src="../config.js"></script>
    <script src="../components.js"></script>

    <style>
        /* Variabel Lokal */
        :root {
            --db-bg: #f8fafc;
            --db-main-text: #1e293b;
            --db-sub-text: #64748b;
            --db-border: #e2e8f0;
            --db-blue: #1a4787;
        }

        body { background-color: var(--db-bg); }
        
        /* --- LAYOUT UTAMA --- */
        main {
            /* Padding default untuk PC/Tablet */
            padding: 30px;
            margin-left: 260px; /* Ruang untuk Sidebar components.js */
            min-height: 100vh;
            transition: margin-left 0.3s, padding 0.3s;
        }

        /* Wrapper agar konten ketengah di layar besar */
        .dashboard-wrapper {
            max-width: 1100px; /* Batasi lebar maksimal agar fokus */
            margin: 0 auto;    /* Tengahkan secara horizontal */
            width: 100%;
        }

        /* --- RESPONSIVE MOBILE (HP) --- */
        @media (max-width: 900px) {
            main { 
                margin-left: 0; 
                /* Padding lebih kecil di HP agar lega */
                padding: 20px 15px; 
            }
        }

        /* === HEADER HALAMAN === */
        .page-header { margin-bottom: 25px; }
        .page-title {
            font-size: 24px; font-weight: 700; color: var(--db-main-text); margin: 0;
        }
        .page-subtitle {
            font-size: 14px; color: var(--db-sub-text); margin-top: 4px;
        }

        /* Penyesuaian Header di Mobile */
        @media (max-width: 600px) {
            .page-title { font-size: 20px; }
            .page-header { margin-bottom: 20px; }
        }

        /* === GRID LAYOUT === */
        .dashboard-grid {
            display: grid;
            /* Otomatis 1 kolom di HP, 2+ kolom di layar lebar */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; /* Jarak default PC */
        }

        /* Jarak grid lebih rapat di mobile */
        @media (max-width: 768px) {
            .dashboard-grid { gap: 15px; }
        }

        /* === CARD STYLE === */
        .db-card {
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--db-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            padding: 20px; /* Padding default PC */
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Padding kartu lebih rapat di mobile */
        @media (max-width: 768px) {
            .db-card { padding: 15px; }
        }

        /* Header Kartu */
        .db-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 12px;
            border-bottom: 1px solid var(--db-border);
        }
        .db-card-title {
            font-size: 16px; font-weight: 600; color: var(--db-main-text);
            display: flex; align-items: center; gap: 10px;
        }
        /* Icon judul kartu */
        .db-card-title i {
            font-size: 18px; color: var(--db-blue);
            background: rgba(26, 71, 135, 0.08); padding: 6px; border-radius: 8px;
        }
        .db-view-link {
            font-size: 12px; font-weight: 500; color: var(--db-blue); text-decoration: none;
            padding: 4px 10px; background: #f0f9ff; border-radius: 20px;
        }

        /* List Items Container */
        .db-list {
            display: flex; flex-direction: column; gap: 10px;
            max-height: 350px; overflow-y: auto;
            padding-right: 2px; /* Ruang untuk scrollbar */
        }
        
        /* Item Style */
        .db-item {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 8px; border-radius: 10px; transition: 0.2s;
            border: 1px solid transparent;
        }
        .db-item:hover { background: #f8fafc; border-color: var(--db-border); }

        /* Visual (Foto/Icon) */
        .item-visual {
            width: 40px; height: 40px; flex-shrink: 0;
        }
        .item-img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 1px solid var(--db-border);
        }
        /* Placeholder jika tidak ada foto */
        .item-placeholder {
            width: 100%; height: 100%; border-radius: 50%; 
            background: #e0f2fe; color: #0284c7;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }
        /* Khusus icon (agenda/posting) */
        .item-icon-box {
             width: 100%; height: 100%; border-radius: 8px;
             display: flex; align-items: center; justify-content: center;
             font-size: 18px;
        }

        /* Teks Item */
        .item-content { flex: 1; min-width: 0; }
        .item-main-text {
            font-size: 14px; font-weight: 600; color: var(--db-main-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .item-sub-text {
            font-size: 12px; color: var(--db-sub-text); line-height: 1.3;
        }
        .item-date {
            font-size: 11px; color: #94a3b8; display: flex; align-items: center; 
            gap: 4px; margin-top: 4px;
        }
        .item-date i { font-size: 12px; }

        /* Pesan Kosong */
        .empty-state {
            text-align: center; color: #94a3b8; font-size: 13px; 
            font-style: italic; padding: 30px 0;
            background: #f9fafb; border-radius: 8px;
        }
    </style>
</head>
<body>

    <main>
        <div class="dashboard-wrapper">
            
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Selamat datang, <span id="admin-name-span">Pengurus</span>!</p>
            </div>

            <div class="dashboard-grid">

                <div class="db-card">
                    <div class="db-card-header">
                        <div class="db-card-title"><i class="ri-fingerprint-line"></i> Presensi Terbaru</div>
                        <a href="../presensi/" class="db-view-link">Semua</a>
                    </div>
                    <div id="list-presensi" class="db-list">
                        <div class="empty-state">Memuat data...</div>
                    </div>
                </div>

                <div class="db-card">
                    <div class="db-card-header">
                        <div class="db-card-title"><i class="ri-group-line"></i> Anggota Baru</div>
                        <a href="../anggota/" class="db-view-link">Semua</a>
                    </div>
                    <div id="list-anggota" class="db-list">
                        <div class="empty-state">Memuat data...</div>
                    </div>
                </div>

                <div class="db-card">
                    <div class="db-card-header">
                        <div class="db-card-title"><i class="ri-calendar-event-line"></i> Agenda Terdekat</div>
                        <a href="../agenda/" class="db-view-link">Semua</a>
                    </div>
                    <div id="list-agenda" class="db-list">
                        <div class="empty-state">Memuat data...</div>
                    </div>
                </div>

                <div class="db-card">
                    <div class="db-card-header">
                        <div class="db-card-title"><i class="ri-article-line"></i> Postingan Terbaru</div>
                        <a href="../posting/" class="db-view-link">Semua</a>
                    </div>
                    <div id="list-posting" class="db-list">
                        <div class="empty-state">Memuat data...</div>
                    </div>
                </div>

            </div> </div> </main>

    <script>
        // === LOGIKA JAVASCRIPT (Tidak Berubah Banyak dari Sebelumnya) ===
        
        let ADMIN_TOKEN = null;

        document.addEventListener('DOMContentLoaded', () => {
            initHC32AdminNavigation('dashboard'); // Render Sidebar

            if (cekSesi()) {
                window.showHC32Status('loading', 'Sinkronisasi...', 'Mengambil data terbaru.');
                ambilDataDashboard().finally(() => window.hideHC32Status());
            }
        });

        // --- FUNGSI CEK SESI ---
        function cekSesi() {
            const params = new URLSearchParams(window.location.search);
            const t = params.get('token'), n = params.get('n'), j = params.get('j'), f = params.get('f');
            let session = null;

            if (t && n) {
                hc32_saveSession(t, n, j, f);
                window.history.replaceState({}, document.title, window.location.pathname);
                session = { token: t, nama: n };
            } else {
                session = hc32_getSession();
            }

            if (!session || !session.token) {
                alert("Sesi habis. Login kembali.");
                window.location.href = "../../keanggotaan/login pengurus/index.html";
                return false;
            }
            ADMIN_TOKEN = session.token;
            document.getElementById('admin-name-span').textContent = session.nama || 'Pengurus';
            return true;
        }

        // --- FUNGSI AMBIL DATA ---
        async function ambilDataDashboard() {
            try {
                const [dPresensi, dAnggota, dAgenda, dPosting] = await Promise.all([
                    hc32_post("getPresensiDashboard", { token: ADMIN_TOKEN }),
                    hc32_post("listAnggotaAdmin", { token: ADMIN_TOKEN }),
                    hc32_post("listKegiatanAdmin", { token: ADMIN_TOKEN }),
                    hc32_post("listPostingAdmin", { token: ADMIN_TOKEN })
                ]);
                renderPresensi(dPresensi?.data);
                renderAnggota(dAnggota?.data);
                renderAgenda(dAgenda?.data);
                renderPosting(dPosting?.data);
            } catch (error) {
                console.error(error);
                window.showHC32Status('error', 'Gagal', 'Koneksi bermasalah.');
            }
        }

        // --- FORMAT TANGGAL INDO ---
        function formatTanggal(str, short = true) {
            if (!str) return '-';
            const d = new Date(str);
            if (isNaN(d)) return str;
            const options = short ? 
                { day: 'numeric', month: 'short' } : 
                { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            return d.toLocaleDateString('id-ID', options);
        }

        // --- FUNGSI RENDER (TAMPILAN) ---

        function renderPresensi(data) {
            const el = document.getElementById('list-presensi');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada data presensi.</div>'; return; }
            
            let html = '';
            data.slice(0, 5).forEach(x => {
                const inisial = x.nama ? x.nama.charAt(0) : '?';
                const visual = x.foto ? `<img src="${x.foto}" class="item-img">` : `<div class="item-placeholder">${inisial}</div>`;
                const tgl = formatTanggal(x.timestamp, false); 

                html += `
                <div class="db-item">
                    <div class="item-visual">${visual}</div>
                    <div class="item-content">
                        <div class="item-main-text">${x.nama}</div>
                        <div class="item-sub-text">${x.pertemuan || 'Pertemuan'} • ${x.jam || ''}</div>
                        <div class="item-date"><i class="ri-calendar-line"></i> ${tgl}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderAnggota(data) {
            const el = document.getElementById('list-anggota');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada anggota baru.</div>'; return; }
            
            const sorted = data.reverse(); 
            let html = '';
            sorted.slice(0, 5).forEach(x => {
                const inisial = x.nama ? x.nama.charAt(0) : '?';
                const visual = x.foto ? `<img src="${x.foto}" class="item-img">` : `<div class="item-placeholder">${inisial}</div>`;
                
                html += `
                <div class="db-item">
                    <div class="item-visual">${visual}</div>
                    <div class="item-content">
                        <div class="item-main-text">${x.nama}</div>
                        <div class="item-sub-text">${x.kelas || x.tipe}</div>
                        <div class="item-date">ID: ${x.id_hc || '-'}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderAgenda(data) {
            const el = document.getElementById('list-agenda');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Tidak ada agenda.</div>'; return; }

            const today = new Date(); today.setHours(0,0,0,0);
            const upcoming = data.filter(d => new Date(d.tanggal) >= today && d.status !== 'draft').sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

            if(upcoming.length === 0) { el.innerHTML = '<div class="empty-state">Tidak ada agenda terdekat.</div>'; return; }

            let html = '';
            upcoming.slice(0, 5).forEach(x => {
                const tgl = formatTanggal(x.tanggal, true);
                html += `
                <div class="db-item">
                    <div class="item-visual">
                        <div class="item-icon-box" style="background:#fff7ed; color:#ea580c;">
                            <i class="ri-calendar-event-line"></i>
                        </div>
                    </div>
                    <div class="item-content">
                        <div class="item-main-text">${x.judul}</div>
                        <div class="item-sub-text">${tgl} • ${x.waktu}</div>
                        <div class="item-date"><i class="ri-map-pin-line"></i> ${x.tempat}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderPosting(data) {
            const el = document.getElementById('list-posting');
            if (!data || data.length === 0) { el.innerHTML = '<div class="empty-state">Belum ada postingan.</div>'; return; }

            let html = '';
            const sorted = data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            sorted.slice(0, 5).forEach(x => {
                const visual = x.gambar ? 
                    `<img src="${x.gambar}" class="item-img" style="border-radius:8px;">` : 
                    `<div class="item-icon-box" style="background:#f0fdf4; color:#16a34a;"><i class="ri-article-line"></i></div>`;
                const tgl = formatTanggal(x.tanggal, true);

                html += `
                <div class="db-item">
                    <div class="item-visual">${visual}</div>
                    <div class="item-content">
                        <div class="item-main-text">${x.judul}</div>
                        <div class="item-sub-text">${x.kategori}</div>
                        <div class="item-date"><i class="ri-time-line"></i> ${tgl}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }
    </script>
</body>
</html>
