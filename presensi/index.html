<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Presensi - Admin HC 32</title>

    <script src="config.js"></script>
    <script src="components.js"></script>

    <style>
        /* Gaya Spesifik Halaman (Tidak disediakan oleh components.js) */
        
        /* Layout Utama - Menyesuaikan dengan Sidebar components.js (Width: 260px) */
        main {
            padding: 30px;
            margin-left: 260px; /* Sesuai lebar sidebar components.js */
            min-height: 100vh;
            transition: margin-left 0.3s, padding 0.3s;
        }

        /* Responsif Mobile */
        @media (max-width: 900px) {
            main { 
                margin-left: 0; 
                padding: 20px 16px; 
            }
        }

        /* Header Halaman Konten */
        .page-header { margin-bottom: 24px; }
        .page-title {
            font-size: 28px; font-weight: 700; color: #2e2e2e; margin: 0 0 4px 0;
        }
        .page-subtitle { font-size: 16px; color: #64748b; margin: 0; }

        /* Container Section */
        .content-section {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(15, 23, 42, .05);
        }
        .section-title {
            font-size: 18px; font-weight: 600; color: #2e2e2e; margin: 0 0 16px 0;
        }

        /* Kontrol Export */
        .export-controls { display: flex; gap: 12px; align-items: center; }
        .hc-select, .hc-button {
            font-family: 'Poppins', sans-serif; font-size: 14px;
            border-radius: 8px; padding: 8px 12px;
            border: 1px solid #cbd5e1;
        }
        .hc-select { flex-grow: 1; }
        .hc-button {
            background-color: #1a4787; color: white; font-weight: 500;
            cursor: pointer; transition: background-color 0.2s; border: none;
        }
        .hc-button:hover { background-color: #0f8a94; }
        .hc-button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        /* Style Tabel */
        .table-wrapper {
            width: 100%; overflow-x: auto;
            border: 1px solid #e2e8f0; border-radius: 8px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td {
            padding: 12px 16px; text-align: left; font-size: 13px;
            border-bottom: 1px solid #e2e8f0;
        }
        th { background-color: #f8fafc; font-weight: 600; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { color: #2e2e2e; }
        tr:last-child td { border-bottom: none; }
        
        td .user-name { font-weight: 600; color: #1e293b; display: block; }
        td .user-id { font-size: 11px; color: #94a3b8; margin-top: 2px; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .export-controls { flex-direction: column; align-items: stretch; }
            .page-title { font-size: 24px; }
        }
    </style>
</head>
<body>

    <main>
        <header class="page-header">
            <div>
                <h1 class="page-title">Daftar Presensi</h1>
                <p class="page-subtitle">Lihat dan ekspor riwayat presensi per pertemuan.</p>
            </div>
        </header>

        <section class="content-section">
            <h2 class="section-title">Export Data Presensi per Pertemuan</h2>
            <div class="export-controls">
                <select id="pertemuan-select" class="hc-select">
                    <option value="">Pilih pertemuan untuk diekspor...</option>
                </select>
                <button id="export-btn" class="hc-button" disabled>Export ke CSV</button>
            </div>
        </section>

        <section class="content-section">
            <h2 class="section-title">Presensi Terbaru (150 Terakhir)</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Nama Anggota</th>
                            <th>Tipe</th>
                            <th>Kelas/Jabatan</th>
                            <th>Pertemuan</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="presensi-table-body">
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- VARIABEL GLOBAL ---
        let ADMIN_TOKEN = null;
        
        // --- INIT HALAMAN ---
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Render Sidebar & Header dari components.js
            // 'presensi' adalah ID menu yang aktif di sidebar
            initHC32AdminNavigation('presensi'); 

            // 2. Cek Sesi & Muat Data
            if (validateSession()) {
                window.showHC32Status('loading', 'Memuat Data...', 'Mengambil riwayat presensi terbaru.');
                
                Promise.all([
                    loadDashboard(),
                    loadPertemuanList()
                ])
                .then(() => {
                    window.hideHC32Status(); // Sembunyikan loader jika sukses
                })
                .catch((err) => {
                    console.error(err);
                    window.showHC32Status('error', 'Gagal Memuat', 'Terjadi kesalahan jaringan.');
                });
            }

            // 3. Event Listeners
            document.getElementById("export-btn").addEventListener("click", exportPresensi);
            document.getElementById("pertemuan-select").addEventListener("change", (e) => {
                document.getElementById("export-btn").disabled = !e.target.value;
            });
        });

        // --- FUNGSI VALIDASI SESI ---
        function validateSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlNama = urlParams.get('n');
            const urlJabatan = urlParams.get('j');
            const urlFoto = urlParams.get('f');

            let session;

            if (urlToken && urlNama) {
                // Login baru: Simpan ke localStorage
                hc32_saveSession(urlToken, urlNama, urlJabatan, urlFoto); 
                window.history.replaceState({}, document.title, window.location.pathname); 
                session = { token: urlToken, nama: urlNama };
            } else {
                // Refresh: Ambil dari localStorage
                session = hc32_getSession(); 
            }

            if (!session || !session.token) {
                alert("Sesi tidak valid. Silakan login kembali.");
                window.location.href = "https://sites.google.com/view/history-club-32/keanggotaan/login-pengurus";
                return false;
            }

            ADMIN_TOKEN = session.token;
            // Catatan: Sidebar components.js akan otomatis mengambil info user (nama/foto) 
            // melalui fungsi fetchHeaderData() internalnya atau dari localStorage, 
            // jadi kita tidak perlu update DOM sidebar manual di sini.
            
            return true;
        }

        // --- FUNGSI DATA: Presensi Terbaru ---
        async function loadDashboard() {
            const out = await hc32_post("getPresensiDashboard", { token: ADMIN_TOKEN });
            const tableBody = document.getElementById("presensi-table-body");
            tableBody.innerHTML = ""; 

            if (out.status !== 'ok' || !out.data || out.data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #94a3b8; padding: 20px;">Belum ada data presensi.</td></tr>`;
                return;
            }

            out.data.forEach(p => {
                const tr = document.createElement("tr");
                const tgl = new Date(p.timestamp);
                const waktuStr = `${tgl.toLocaleDateString('id-ID')} - ${p.jam}`;
                
                let detail = '-';
                if (p.tipe === 'siswa-aktif') {
                    detail = p.kelas || '-';
                } else if (p.tipe === 'guru' || p.tipe === 'non-32') {
                    detail = p.roleTag || p.jabatan || '-';
                } else if (p.tipe === 'alumni') {
                    detail = 'Alumni';
                }

                tr.innerHTML = `
                    <td>
                        <span class="user-name">${p.nama}</span>
                        <span class="user-id">ID: ${p.id_hc || p.nis}</span>
                    </td>
                    <td>${p.tipe}</td>
                    <td>${detail}</td>
                    <td>${p.pertemuan}</td>
                    <td>${waktuStr}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- FUNGSI DATA: List Pertemuan ---
        async function loadPertemuanList() {
            const selectEl = document.getElementById("pertemuan-select");
            const out = await hc32_post("listPertemuan", { token: ADMIN_TOKEN });

            if (out.status === 'ok' && out.data.length > 0) {
                out.data.sort().reverse(); 
                out.data.forEach(pertemuan => {
                    const opt = document.createElement("option");
                    opt.value = pertemuan;
                    opt.textContent = pertemuan;
                    selectEl.appendChild(opt);
                });
            }
        }
        
        // --- FUNGSI EXPORT CSV ---
        function convertJSONToCSV(data) {
            if (!data || data.length === 0) return "";
            
            const headers = ['ID_HC', 'NIS', 'Nama', 'Tipe', 'Kelas/Jabatan', 'Pertemuan', 'Timestamp', 'Jam'];
            let csv = headers.join(',') + '\n';
            
            data.forEach(p => {
                let detail = '-';
                if (p.tipe === 'siswa-aktif') detail = p.kelas || '-';
                else if (p.tipe === 'guru' || p.tipe === 'non-32') detail = p.roleTag || p.jabatan || '-';
                else if (p.tipe === 'alumni') detail = 'Alumni';
                
                const nama = `"${(p.nama || '').replace(/"/g, '""')}"`;
                const pertemuan = `"${(p.pertemuan || '').replace(/"/g, '""')}"`;
                
                const row = [
                    p.id_hc || p.nis, p.nis, nama, p.tipe, detail,
                    pertemuan, p.timestamp, p.jam
                ];
                csv += row.join(',') + '\n';
            });
            return csv;
        }

        async function exportPresensi() {
            const selectEl = document.getElementById("pertemuan-select");
            const exportBtn = document.getElementById("export-btn");
            const pertemuan = selectEl.value;
            
            if (!pertemuan) {
                alert("Pilih pertemuan terlebih dahulu.");
                return;
            }

            exportBtn.disabled = true;
            exportBtn.textContent = "Mengekspor...";
            
            // Tampilkan loading spinner dari components.js
            window.showHC32Status('loading', 'Mengekspor...', 'Sedang menyiapkan file CSV.');

            try {
                const out = await hc32_post("listPresensiByPertemuan", { token: ADMIN_TOKEN, pertemuan: pertemuan });
                
                if (out.status !== 'ok' || !out.data || out.data.length === 0) {
                    window.showHC32Status('error', 'Data Kosong', 'Tidak ada data presensi untuk pertemuan ini.');
                    return;
                }
                
                const csvContent = convertJSONToCSV(out.data);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const fileName = `presensi_${pertemuan.replace(/ /g, '_')}.csv`;
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Sukses
                window.showHC32Status('success', 'Berhasil', 'File CSV telah diunduh.');
                // Hilangkan status sukses setelah 2 detik
                setTimeout(() => window.hideHC32Status(), 2000);

            } catch(err) {
                window.showHC32Status('error', 'Gagal', 'Terjadi kesalahan saat ekspor: ' + err.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = "Export ke CSV";
            }
        }
    </script>
</body>
</html>
