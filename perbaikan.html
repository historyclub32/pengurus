<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perbaikan Data - Admin HC 32</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        :root {
            --hc-blue: #1a4787; --hc-toska: #0f8a94; --hc-dark: #2e2e2e;
            --hc-green: #15a256; --hc-red: #d30e14; --hc-bg: #f8fafc;
            --c-siswa: #1a4787; --c-guru: #0f8a94; --c-alumni: #F97316; --c-non32: #2e2e2e;
            
            /* Warna untuk badge jabatan */
            --role-pembina-fg: #2e2e2e; /* Foreground (text & border) */
            --role-pelatih-fg: #2e5eab;
            --role-ketua-fg: #0f8a94;
            --role-wakil-fg: #1a4787;
            --role-pengurus-fg: #d30e14; /* Termasuk bendahara, sekretaris, divisi */
        }
        @keyframes hcspin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadein { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--hc-bg); 
            color: var(--hc-dark); 
            margin: 0; 
            display: flex; 
            min-height: 100vh;
        }
        
        #app-status-overlay {
            position: fixed; inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadein 0.2s ease-out forwards;
        }
        #app-status-box {
            background: white; border-radius: 16px; padding: 24px;
            width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            animation: fadein 0.3s 0.1s ease-out backwards;
        }
        .status-icon { margin: 0 auto 16px auto; width: 80px; height: 80px; }
        #app-status-title { font-size: 20px; font-weight: 700; color: var(--hc-dark); margin: 0 0 12px 0; }
        #app-status-message { font-size: 15px; color: #475569; margin: 0 0 24px 0; line-height: 1.6; word-wrap: break-word; }
        #app-status-buttons { display: flex; gap: 12px; }
        .btn-modal { flex: 1; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 15px; }
        .btn-modal.primary { background: var(--hc-blue); color: white; }
        .btn-modal.secondary { background: #e2e8f0; color: var(--hc-dark); }
        
        .hc-loader { position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .hc-loader-spinner { position: absolute; inset: 0; border-radius: 50%; border: 6px solid var(--hc-blue); border-top-color: var(--hc-toska); animation: hcspin 1s linear infinite; }
        .hc-loader-logo { width: 56px; height: 56px; border-radius: 50%; }

        .checkmark { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 4; stroke: var(--hc-green); stroke-miterlimit: 10; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 4; stroke-miterlimit: 10; stroke: var(--hc-green); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.3s forwards; }
        
        .cross { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 4; stroke: var(--hc-red); stroke-miterlimit: 10; }
        .cross__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 4; stroke-miterlimit: 10; stroke: var(--hc-red); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .cross__line1 { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.3s forwards; }
        .cross__line2 { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.4s forwards; }

        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        
        aside { 
            width: 240px; background: white; border-right: 1px solid #e2e8f0; 
            padding: 20px; display: flex; flex-direction: column; z-index: 500;
            flex-shrink: 0; position: fixed; inset: 0 auto 0 0;
            transition: transform 0.3s ease; box-sizing: border-box;
        }
        .aside-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .aside-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        main { 
            flex: 1; padding: 32px; overflow-y: auto; 
            position: relative; margin-left: 240px;
            animation: pageFadeIn 0.4s ease-out;
        }
        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-item { display: block; padding: 10px 12px; color: #334155; text-decoration: none; border-radius: 6px; margin-bottom: 4px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #f1f5f9; color: var(--hc-blue); }
        .nav-item.active { font-weight: 600; background: rgba(26, 71, 135, 0.08); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 24px 0; }
        .page-header h1 { margin: 0; font-size: 28px; }
        #btn-open-sidebar {
            display: none; background: white; border: 1px solid #cbd5e1;
            border-radius: 6px; width: 36px; height: 36px;
            align-items: center; justify-content: center; cursor: pointer; font-size: 20px;
        }

        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; gap: 12px; }
        .search-input { flex: 1; padding: 0 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; height: 42px; box-sizing: border-box; }
        select.search-input { -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2364748B%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 14px center; background-size: 10px; }
        .search-input:focus { border-color: var(--hc-blue); outline: none; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background-color 0.2s, opacity 0.2s; height: 42px; box-sizing: border-box; }
        .btn:disabled { background-color: #cbd5e1!important; color: #64748b!important; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background: var(--hc-blue); color: white; }
        .btn-secondary { background: var(--hc-toska); color: white; }
        .btn-danger { background: var(--hc-red); color: white; }
        
        #scanner-modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 1500;
            align-items: center; justify-content: center;
            padding: 16px; box-sizing: border-box;
        }
        #scanner-box { background: black; border-radius: 12px; padding: 16px; width: 100%; max-width: 500px; }
        #qr-reader { width: 100%; }

        #search-results-container {
            display: none; background: white; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin: -16px 0 24px 0; padding: 16px;
        }
        .result-item { padding: 12px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .result-item:hover { background-color: #f1f5f9; }
        .result-item-nama { font-weight: 600; color: var(--hc-dark); }
        .result-item-info { font-size: 13px; color: #64748b; text-align: right; display: flex; align-items: center; gap: 8px; }

        .tipe-badge {
            font-size: 11px; font-weight: 600; padding: 3px 8px;
            border-radius: 6px; color: white; text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.6); 
        }
        .tipe-siswa { background-color: var(--c-siswa); }
        .tipe-guru { background-color: var(--c-guru); }
        .tipe-alumni { background-color: var(--c-alumni); }
        .tipe-non32 { background-color: var(--c-non32); }
        
        .jabatan-badge {
            font-size: 11px; font-weight: 600; padding: 3px 8px;
            border-radius: 6px; 
            background-color: white; /* Background putih */
            border: 1px solid; /* Border sesuai warna jabatan */
        }
        .jabatan-pembina { color: var(--role-pembina-fg); border-color: var(--role-pembina-fg); }
        .jabatan-pelatih { color: var(--role-pelatih-fg); border-color: var(--role-pelatih-fg); }
        .jabatan-ketua { color: var(--role-ketua-fg); border-color: var(--role-ketua-fg); }
        .jabatan-wakil { color: var(--role-wakil-fg); border-color: var(--role-wakil-fg); }
        .jabatan-pengurus { color: var(--role-pengurus-fg); border-color: var(--role-pengurus-fg); }


        #member-card { display: none; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 32px; }
        .member-header { background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska)); color: white; padding: 24px; display: flex; align-items: center; gap: 20px; }
        .member-photo { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; object-fit: cover; border: 3px solid white; flex-shrink: 0; }
        .member-info h2 { margin: 0; font-size: 24px; word-break: break-word; }
        .member-info p { margin: 4px 0 0 0; opacity: 0.9; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #m-kelas-info { margin-top: 0; }


        #tools-container { display: none; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .tool-card { background: white; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .tool-title { font-weight: 600; font-size: 18px; margin-bottom: 16px; color: var(--hc-dark); display: flex; align-items: center; gap: 10px; }
        
        .input-group { display: flex; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px; transition: border-color 0.2s; }
        .input-group:focus-within { border-color: var(--hc-blue); }
        .input-group .search-input { flex: 1; border: none; height: 38px; }
        .input-group select#edit-kode-hp { 
            flex: 0 1 75px; 
            max-width: 90px; 
            min-width: 60px; 
            border-radius: 8px 0 0 8px; 
            padding-left: 10px; 
            border-right: 2px solid #e2e8f0; 
            background-position: right 8px center; 
            padding-right: 25px; 
        }
        .input-group input.search-input { border-radius: 0 8px 8px 0; }
        .input-group.no-btn input.search-input { border-radius: 8px; border-left: 2px solid #e2e8f0; }
        .btn-scan {
            padding: 0 14px; background: #f8fafc; color: var(--hc-dark); font-size: 16px;
            height: 38px; border-radius: 0 8px 8px 0; border: none; border-left: 2px solid #e2e8f0;
        }
        .btn-scan:disabled {
            background: #f1f5f9; color: #cbd5e1; cursor: not-allowed;
            border-color: #e2e8f0; opacity: 0.7;
        }
        
        .form-label {font-size: 13px; font-weight: 600; display: block; margin-bottom: 4px; margin-top: 10px;} 
        .form-field { width: 100%; box-sizing: border-box; }
        .form-field:disabled, .form-field[disabled] { background: #f1f5f9!important; color: #94a3b8!important; cursor: not-allowed!important; opacity: 1; }

        input[type="date"] { position: relative; background: white; padding: 9px 12px; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6; }

        #ttd-preview-container { margin-bottom: 12px; display: none; }
        #ttd-preview-container img { width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; }
        .signature-wrapper { border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; touch-action: none; }
        canvas#signature-pad { width: 100%; height: 200px; display: block; border-radius: 8px; }

        #webcam-container { display: none; margin-bottom: 12px; position: relative; }
        #webcam-preview { width: 100%; border-radius: 8px; background: #eee; }
        #btn-capture-foto { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); }
        #webcam-canvas { display: none; } 
        #file-upload-container { display: flex; gap: 10px; margin-bottom: 12px; }
        #btn-toggle-webcam, #btn-pilih-file { flex: 1; }
        input[type="file"]#foto-input { display: none; } 
        #foto-upload-info { font-size: 12px; color: #64748b; margin-top: 4px; }
        
        #foto-existing-preview, #foto-new-preview { display: none; }
        #foto-preview-wrapper { position: relative; margin-bottom: 12px; }
        #foto-preview-wrapper img { 
            width: 100%; height: 200px; 
            object-fit: contain; 
            background: #f1f5f9; border-radius: 8px;
        }
        #btn-clear-preview { 
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.6); color: white;
            border: none; border-radius: 50%;
            width: 30px; height: 30px;
            font-size: 16px; font-weight: bold;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            line-height: 1;
        }

        #cropper-modal {
             position: fixed; inset: 0; background: rgba(0,0,0,0.8);
             z-index: 2500; display: none; align-items: center; justify-content: center;
             padding: 20px; box-sizing: border-box;
         }
        #cropper-container { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; }
        #cropper-image-container { max-height: 60vh; margin-bottom: 20px; }
        #cropper-image-container img { max-width: 100%; display: block; }

        @media (max-width: 900px) {
            aside { transform: translateX(-100%); height: 100%; position: fixed; }
            aside.open { transform: translateX(0); }
            main { margin-left: 0; width: 100%; box-sizing: border-box; }
            #btn-open-sidebar { display: inline-flex; }
            .search-box { flex-direction: column; }
            .member-header { flex-direction: column; text-align: center; }
            .page-header h1 { font-size: 22px; }
        }
        @media (max-width: 768px) {
            main { padding: 20px 16px; }
            #file-upload-container { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="app-status-overlay">
        <div id="app-status-box">
            <div id="status-loader" class="status-icon">
                <div class="hc-loader">
                    <div class="hc-loader-spinner"></div>
                    <img src="https://lh3.googleusercontent.com/d/1lAev2D5Pxp5Rt36iy4y0YMibEnYu5BgI" class="hc-loader-logo" alt="Logo HC">
                </div>
            </div>
            <div id="status-success" class="status-icon" style="display: none;">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <div id="status-error" class="status-icon" style="display: none;">
                <svg class="cross" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                     <circle class="cross__circle" cx="26" cy="26" r="25" fill="none"/>
                     <path class="cross__line1" fill="none" d="M16 16 36 36"/>
                     <path class="cross__line2" fill="none" d="M36 16 16 36"/>
                </svg>
            </div>
            <h2 id="app-status-title">Judul</h2>
            <p id="app-status-message">Pesan...</p>
            <div id="app-status-buttons">
                <button id="app-status-btn-cancel" class="btn-modal secondary">Batal</button>
                <button id="app-status-btn-ok" class="btn-modal primary">Oke</button>
            </div>
        </div>
    </div>


    <aside id="sidebar">
        <div class="aside-header">
             <img src="https://lh3.googleusercontent.com/d/1lAev2D5Pxp5Rt36iy4y0YMibEnYu5BgI" alt="Foto Admin" class="aside-logo" id="admin-foto-display">
            <div>
                <div style="font-weight: 700; color: var(--hc-blue);" id="admin-jabatan-display">Admin HC</div>
                <div style="font-size: 12px; color: #64748b;" id="admin-name-display">Memuat...</div>
            </div>
        </div>
        <nav>
            <a href="dashboard.html" class="nav-item">Dashboard</a>
            <a href="presensi.html" class="nav-item">Presensi</a>
            <a href="admin-agenda.html" class="nav-item">Agenda</a>
            <a href="admin-posting.html" class="nav-item">Posting</a>
            <a href="admin-anggota.html" class="nav-item">Anggota</a>
            <a href="admin-kepengurusan.html" class="nav-item">Kepengurusan</a>
            <a href="perbaikan.html" class="nav-item active">Perbaikan Data</a>
            <a href="#" id="logout-btn" class="nav-item" style="color: var(--hc-red); margin-top: auto;">Logout</a>
        </nav>
    </aside>

    <main>
        <header class="page-header">
            <h1>Alat Perbaikan Data</h1>
            <button id="btn-open-sidebar" aria-label="Buka menu">‚ò∞</button>
        </header>

        <div class="search-box">
            <input type="text" id="search-name-input" class="search-input" placeholder="Ketik nama anggota (min. 3 huruf)...">
            <button class="btn btn-primary" id="btn-cari-nama">üîç Cari Nama</button>
        </div>

        <div id="search-results-container">
            <h3 style="margin: 0 0 8px 0; font-size: 16px;">Hasil Pencarian:</h3>
            <div id="search-results-list"></div>
        </div>

        <div id="member-card">
            <div class="member-header">
                <img id="m-foto" class="member-photo" src="https://placehold.co/80x80/e2e8f0/1e293b?text=No+Img" alt="Foto Profil">
                <div class="member-info">
                    <h2 id="m-nama">Nama Anggota</h2>
                    <p style="display: flex; align-items: center; gap: 8px;">
                        <span id="m-tipe-badge-container"></span>
                        <span id="m-jabatan-badge-container"></span>
                        <span id="m-kelas-info"></span> </p>
                    <p style="font-family: monospace; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 8px;">
                        <span id="m-nis-label">NIS</span>: <span id="m-nis">-</span> | ID HC: <span id="m-idhc">-</span>
                    </p>
                </div>
            </div>
        </div>

        <div id="tools-container" class="tools-grid">
            
            <div class="tool-card">
                <div class="tool-title">üí≥ Perbaikan Nomor ID</div>
                <label class="form-label" for="edit-nis">NIS (7 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nis" class="search-input form-field" placeholder="7 Digit" maxlength="7">
                    <button id="btn-scan-nis" class="btn btn-scan form-field" onclick="startScanner('edit-nis')">üì∑</button>
                </div>
                <label class="form-label" for="edit-nisn">NISN (10 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nisn" class="search-input form-field" placeholder="10 Digit" maxlength="10">
                    <button id="btn-scan-nisn" class="btn btn-scan form-field" onclick="startScanner('edit-nisn')">üì∑</button>
                </div>
                <label class="form-label" for="edit-nip">NIP (18 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nip" class="search-input form-field" placeholder="18 Digit" maxlength="18">
                    <button id="btn-scan-nip" class="btn btn-scan form-field" onclick="startScanner('edit-nip')">üì∑</button>
                </div>
                <label class="form-label" for="edit-perpus">No. Anggota Perpus (Opsional)</label>
                <div class="input-group">
                    <input type="text" id="edit-perpus" class="search-input form-field" placeholder="6-9 Digit" maxlength="9">
                    <button id="btn-scan-perpus" class="btn btn-scan form-field" onclick="startScanner('edit-perpus')">üì∑</button>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btn-simpan-id">Simpan Nomor ID</button>
            </div>
                        
                        <label class="form-label" for="edit-email">Email</label>
                        <input type="email" id="edit-email" class="search-input form-field">
                    </div>
                </div>
                <label class="form-label" for="edit-jabatan">Jabatan (Struktural/Eksternal)</label>
                <input type="text" id="edit-jabatan" class="search-input form-field" style="margin-bottom: 16px;">
                <button class="btn btn-primary" style="width: 100%;" id="btn-simpan-personal">Simpan Data Personal</button>
            </div>

            <div class="tool-card">
                <div class="tool-title">üí≥ Perbaikan Nomor ID</div>
                <label class="form-label" for="edit-nis">NIS (7 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nis" class="search-input form-field" placeholder="7 Digit" maxlength="7">
                    <button id="btn-scan-nis" class="btn btn-scan form-field" onclick="startScanner('edit-nis')">üì∑</button>
                </div>
                <label class="form-label" for="edit-nisn">NISN (10 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nisn" class="search-input form-field" placeholder="10 Digit" maxlength="10">
                    <button id="btn-scan-nisn" class="btn btn-scan form-field" onclick="startScanner('edit-nisn')">üì∑</button>
                </div>
                <label class="form-label" for="edit-nip">NIP (18 Digit)</label>
                <div class="input-group">
                    <input type="text" id="edit-nip" class="search-input form-field" placeholder="18 Digit" maxlength="18">
                    <button id="btn-scan-nip" class="btn btn-scan form-field" onclick="startScanner('edit-nip')">üì∑</button>
                </div>
                <label class="form-label" for="edit-perpus">No. Anggota Perpus (Opsional)</label>
                <div class="input-group">
                    <input type="text" id="edit-perpus" class="search-input form-field" placeholder="6-9 Digit" maxlength="9">
                    <button id="btn-scan-perpus" class="btn btn-scan form-field" onclick="startScanner('edit-perpus')">üì∑</button>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btn-simpan-id">Simpan Nomor ID</button>
            </div>

            <div class="tool-card">
                <div class="tool-title">üñºÔ∏è Upload Foto Profil</div>
                
                <div id="foto-existing-preview" style="display:none; margin-bottom: 12px;">
                    <p style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Foto Saat Ini:</p>
                    <img style="width: 100%; height: 200px; object-fit: contain; background: #f1f5f9; border-radius: 8px;">
                </div>

                <div id="webcam-container">
                    <video id="webcam-preview" autoplay playsinline></video>
                    <button id="btn-capture-foto" class="btn btn-primary">Ambil Foto</button>
                </div>
                <canvas id="webcam-canvas" style="display: none;"></canvas>

                <div id="file-upload-container">
                    <button id="btn-toggle-webcam" class="btn btn-secondary">üì∑ Guna Kamera</button>
                    <input type="file" id="foto-input" accept="image/jpeg, image/png">
                    <button id="btn-pilih-file" class="btn btn-secondary">üìÅ Pilih File</button>
                </div>
                <p id="foto-upload-info">Batas maks: 1 MB. Foto akan di-crop 1:1.</p>
                
                <div id="foto-preview-wrapper">
                    <img id="foto-preview">
                    <button id="btn-clear-preview">√ó</button>
                </div>
                <button id="btn-upload-foto" class="btn btn-primary" style="width: 100%;" disabled>Upload Foto</button>
            </div>

            <div class="tool-card">
                <div class="tool-title">‚úçÔ∏è Tanda Tangan Digital</div>
                <div id="ttd-preview-container">
                    <p style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Tanda Tangan Saat Ini:</p>
                    <img id="ttd-preview" alt="Tanda Tangan Lama">
                    <p style="font-size: 12px; color: #64748b; text-align: center; margin-top: 4px;">Mulai gambar di kotak bawah untuk mengganti.</p>
                </div>
                <div class="signature-wrapper">
                    <canvas id="signature-pad"></canvas>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 12px;">
                    <button id="btn-ttd-clear" class="btn btn-danger" style="flex: 1;">Hapus</button>
                    <button id="btn-ttd-simpan" class="btn btn-primary" style="flex: 2;">Simpan TTD</button>
                </div>
            </div>

            <div class="tool-card">
                <div class="tool-title">üîÑ Ubah Tipe Keanggotaan</div>
                <p style="font-size: 14px; color: #64748b; margin-bottom: 12px;">
                    Mengganti tipe akan memperbarui status anggota.
                </p>
                <label class="form-label" for="edit-tipe">Tipe Keanggotaan Baru</label>
                <select id="edit-tipe" class="search-input form-field" style="margin-bottom: 16px;">
                    <option value="siswa-aktif">Siswa Aktif</option>
                    <option value="guru">Guru/Tendik</option>
                    <option value="alumni">Alumni</option>
                    <option value="non-32">Selain SMAN 32</option>
                </select>
                <button id="btn-simpan-tipe" class="btn btn-primary" style="width: 100%;">Simpan Tipe Baru</button>
            </div>
            
            <div class="tool-card" id="tool-generate-idhc">
                <div class="tool-title">üÜî Generate ID HC</div>
                <p style="font-size: 14px; color: #64748b;">
                    Anggota ini belum memiliki ID HC. Klik tombol di bawah untuk membuatnya.
                </p>
                <button id="btn-generate-id" class="btn btn-primary" style="width: 100%; margin-top: 16px; background: linear-gradient(to right, var(--hc-blue), var(--hc-toska));">
                    ‚ö° Generate ID Sekarang
                </button>
            </div>
        </div>
    </main>

    <div id="scanner-modal" style="display: none; flex-direction: column;">
        <div id="scanner-box">
            <div id="qr-reader"></div>
        </div>
        <button class="btn btn-danger" id="btn-stop-scan" style="margin-top: 16px; width: 90%; max-width: 500px;">Tutup Kamera</button>
    </div>

    <div id="cropper-modal">
        <div id="cropper-container">
            <h2 style="margin: 0 0 16px 0; text-align: center;">Crop Foto 1:1</h2>
            <div id="cropper-image-container">
                <img id="cropper-image" alt="Preview">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button id="btn-cropper-cancel" class="btn btn-danger" style="flex: 1;">Batal</button>
                <button id="btn-cropper-save" class="btn btn-primary" style="flex: 2;">Simpan & Lanjutkan</button>
            </div>
        </div>
    </div>


<script>
    // --- 0. INIT & SESSION CHECK ---
    let CURRENT_MEMBER = null;
    let signaturePad = null;
    let html5QrCode = null;
    let scanTargetField = null;
    let webcamStream = null;
    let currentPhotoBlob = null;
    let cropper = null;
    const MAX_FILE_SIZE = (1 * 1024 * 1024) + 10240; // 1MB + 10KB

    // Elemen UI Modal
    const MODAL = document.getElementById("app-status-overlay");
    const MODAL_ICON_LOAD = document.getElementById("status-loader");
    const MODAL_ICON_SUCCESS = document.getElementById("status-success");
    const MODAL_ICON_ERROR = document.getElementById("status-error");
    const MODAL_TITLE = document.getElementById("app-status-title");
    const MODAL_MSG = document.getElementById("app-status-message");
    const MODAL_BUTTONS = document.getElementById("app-status-buttons");
    const MODAL_OK = document.getElementById("app-status-btn-ok");
    const MODAL_CANCEL = document.getElementById("app-status-btn-cancel");
    
    const ROLE_CLASS = { 
        "Pembina": "jabatan-pembina", 
        "Pelatih": "jabatan-pelatih", 
        "Ketua": "jabatan-ketua", 
        "Wakil Ketua": "jabatan-wakil", 
        "Pengurus": "jabatan-pengurus" 
    };

    document.addEventListener("DOMContentLoaded", async () => {
        showStatus('load', 'Memuat Halaman...');
        const session = hc32_getSession();
        if (!session.token) {
            window.location.href = 'https://sites.google.com/view/history-club-32/keanggotaan/login-pengurus';
            return;
        }
        document.getElementById('admin-name-display').textContent = session.nama || 'Admin';
        document.getElementById('admin-jabatan-display').textContent = session.jabatan || 'Anggota';
        document.getElementById('admin-foto-display').src = session.foto || 'https://lh3.googleusercontent.com/d/1lAev2D5Pxp5Rt36iy4y0YMibEnYu5BgI';
        
        populateKelasDropdown();
        populateAngkatanDropdown();

        // Init Signature Pad
        const canvas = document.getElementById('signature-pad');
        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            if (signaturePad) signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);
        signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(248, 250, 252)' });
        signaturePad.addEventListener("beginStroke", () => {
            document.getElementById('ttd-preview-container').style.display = 'none';
        });

        // --- Event Listeners ---
        document.getElementById('search-name-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); cariAnggotaByNama(); }
        });
        document.getElementById('btn-cari-nama').addEventListener('click', cariAnggotaByNama);
        document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); hc32_logout(); });
        
        const sb = document.getElementById("sidebar");
        document.getElementById("btn-open-sidebar").addEventListener("click", () => sb.classList.toggle("open"));

        document.getElementById('btn-stop-scan').addEventListener('click', stopScanner);
        document.getElementById('btn-simpan-personal').addEventListener('click', simpanDataPersonal);
        document.getElementById('btn-simpan-id').addEventListener('click', simpanPerbaikanID);
        document.getElementById('btn-ttd-clear').addEventListener('click', () => signaturePad.clear());
        document.getElementById('btn-ttd-simpan').addEventListener('click', simpanTandaTangan);
        document.getElementById('btn-generate-id').addEventListener('click', generateIDHC);
        document.getElementById('btn-simpan-tipe').addEventListener('click', simpanTipeKeanggotaan); 
        
        document.getElementById('btn-toggle-webcam').addEventListener('click', toggleWebcam);
        document.getElementById('btn-pilih-file').addEventListener('click', () => document.getElementById('foto-input').click());
        document.getElementById('foto-input').addEventListener('change', handleFileSelect);
        document.getElementById('btn-capture-foto').addEventListener('click', captureFoto);
        document.getElementById('btn-upload-foto').addEventListener('click', uploadFoto);
        document.getElementById('btn-clear-preview').addEventListener('click', clearFotoPreview);
        
        document.getElementById('btn-cropper-cancel').addEventListener('click', closeCropper);
        document.getElementById('btn-cropper-save').addEventListener('click', saveCroppedImage);
        
        hideStatus();
    });

    // --- 1. FUNGSI LOADING & POP-UP ---
    function showStatus(mode, title, message = '', onConfirm = null) {
        MODAL_ICON_LOAD.style.display = 'none';
        MODAL_ICON_SUCCESS.style.display = 'none';
        MODAL_ICON_ERROR.style.display = 'none';
        MODAL_BUTTONS.style.display = 'none';
        MODAL_OK.textContent = 'Oke';
        
        MODAL_TITLE.textContent = title;
        MODAL_MSG.textContent = message;

        if (mode === 'load') MODAL_ICON_LOAD.style.display = 'block';
        else if (mode === 'success') {
            MODAL_ICON_SUCCESS.style.display = 'block';
            MODAL_BUTTONS.style.display = 'flex';
            MODAL_CANCEL.style.display = 'none';
        } else if (mode === 'error') {
            MODAL_ICON_ERROR.style.display = 'block';
            MODAL_BUTTONS.style.display = 'flex';
            MODAL_CANCEL.style.display = 'none';
        } else if (mode === 'confirm') {
            MODAL_BUTTONS.style.display = 'flex';
            MODAL_CANCEL.style.display = 'block';
            MODAL_OK.textContent = 'Yakin';
            MODAL_CANCEL.textContent = 'Batal';
        }
        
        MODAL.style.display = 'flex';
        MODAL_OK.onclick = () => { hideStatus(); if (onConfirm) onConfirm(); };
        MODAL_CANCEL.onclick = () => { hideStatus(); };
    }
    function hideStatus() { MODAL.style.display = 'none'; }
    
    // --- FUNGSI DROPDOWN ---
    function populateKelasDropdown() {
        const select = document.getElementById('edit-kelas');
        select.innerHTML = '<option value="">Pilih Kelas...</option>';
        const tingkat = ['X', 'XI', 'XII'];
        for (let t = 0; t < tingkat.length; t++) {
            for (let i = 1; i <= 8; i++) {
                const value = `${tingkat[t]}-${i}`;
                select.options.add(new Option(value, value));
            }
        }
    }
    function populateAngkatanDropdown() {
        const select = document.getElementById('edit-angkatan');
        select.innerHTML = '<option value="">Pilih Angkatan...</option>';
        const now = new Date();
        let currentYear = now.getFullYear();
        const currentMonth = now.getMonth(); 
        if (currentMonth < 6) currentYear--; 
        const startAngkatan = currentYear + 1;
        for (let i = 0; i < 3; i++) {
            const value = startAngkatan + i;
            select.options.add(new Option(value.toString(), value.toString()));
        }
    }

    // --- 2. FUNGSI PENCARIAN NAMA ---
    async function cariAnggotaByNama() {
        const query = document.getElementById('search-name-input').value;
        if (query.length < 3) {
            showStatus("error", "Input Kurang", "Ketik minimal 3 huruf nama untuk memulai pencarian.");
            return;
        }
        showStatus("load", "Mencari data...");
        hideAllTools(); 
        document.getElementById('search-results-container').style.display = 'none';
        try {
            const res = await hc32_post('cariAnggotaByNama', { token: hc32_getSession().token, nama: query });
            hideStatus(); 
            if (res.status === 'ok') tampilkanHasilPencarian(res.data);
            else showStatus("error", "Gagal Mencari", res.message);
        } catch (e) { showStatus("error", "Error Jaringan", e.message); }
    }

    function formatTipe(tipe) {
        tipe = (tipe || 'siswa-aktif').toLowerCase();
        switch (tipe) {
            case 'siswa-aktif': return { text: 'Siswa', className: 'tipe-siswa' };
            case 'guru': return { text: 'Guru/Tendik', className: 'tipe-guru' };
            case 'alumni': return { text: 'Alumni', className: 'tipe-alumni' };
            case 'non-32': return { text: 'Selain SMAN 32', className: 'tipe-non32' };
            default: return { text: tipe, className: 'tipe-non32' };
        }
    }

    function getJabatanBadge(jabatan) {
        if (!jabatan || jabatan === 'Anggota') return ''; 
        
        let roleClass = null;
        let jabatanText = jabatan;
        
        if (ROLE_CLASS[jabatan]) {
            roleClass = ROLE_CLASS[jabatan];
        } 
        else if (jabatan.toLowerCase().includes('ketua')) roleClass = "jabatan-ketua";
        else if (jabatan.toLowerCase().includes('wakil')) roleClass = "jabatan-wakil";
        else if (jabatan.toLowerCase().includes('bendahara') || jabatan.toLowerCase().includes('sekretaris') || jabatan.toLowerCase().includes('divisi')) roleClass = "jabatan-pengurus";
        else if (jabatan.toLowerCase().includes('pembina')) roleClass = "jabatan-pembina";
        else if (jabatan.toLowerCase().includes('pelatih')) roleClass = "jabatan-pelatih";

        if (roleClass) {
            return `<span class="jabatan-badge ${roleClass}">
                    ${jabatanText}
            </span>`;
        }
        return ''; 
    }

    function tampilkanHasilPencarian(matches) {
        const listContainer = document.getElementById('search-results-list');
        const container = document.getElementById('search-results-container');
        listContainer.innerHTML = ''; 
        if (matches.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center; color: #64748b;">Nama tidak ditemukan.</p>';
            container.style.display = 'block';
            return;
        }
        if (matches.length === 1) {
            getAnggotaPenuh(matches[0].nis);
            return;
        }
        matches.forEach(m => {
            const item = document.createElement('div');
            item.className = 'result-item';
            const tipeInfo = formatTipe(m.tipe);
            item.innerHTML = `
                <div class="result-item-nama">${m.nama}</div>
                <div class="result-item-info">
                    <span class="tipe-badge ${tipeInfo.className}">${tipeInfo.text}</span>
                    <span>‚Ä¢ ${m.nis}</span>
                </div>
            `;
            item.onclick = () => getAnggotaPenuh(m.nis);
            listContainer.appendChild(item);
        });
        container.style.display = 'block';
    }

    async function getAnggotaPenuh(nis) {
        showStatus("load", "Mengambil data lengkap...");
        document.getElementById('search-results-container').style.display = 'none'; 
        try {
            const res = await hc32_post('cariAnggotaUntukPerbaikan', { token: hc32_getSession().token, query: nis });
            if (res.status === 'ok') tampilkanAnggota(res.data);
            else showStatus("error", "Gagal Mengambil", res.message);
        } catch (e) { showStatus("error", "Error Jaringan", e.message); }
        finally { hideStatus(); }
    }

    // =========================================================================
    // INI ADALAH FUNGSI YANG DIPERBARUI UNTUK MENGISI FORM ID DENGAN BENAR
    // =========================================================================
    function tampilkanAnggota(data) {
        CURRENT_MEMBER = data; 
        
        const tipe = (data.tipe || 'siswa-aktif').toLowerCase();
        const tipeInfo = formatTipe(tipe);
        document.getElementById('m-nama').textContent = data.nama;
        document.getElementById('m-tipe-badge-container').innerHTML = `<span class="tipe-badge ${tipeInfo.className}">${tipeInfo.text}</span>`;
        document.getElementById('m-jabatan-badge-container').innerHTML = getJabatanBadge(data.jabatan); 
        
        const kelasInfoEl = document.getElementById('m-kelas-info');
        if (tipe === 'siswa-aktif' && data.kelas) {
            kelasInfoEl.textContent = `‚Ä¢ ${data.kelas}`;
            kelasInfoEl.style.display = 'inline';
        } else {
            kelasInfoEl.textContent = '';
            kelasInfoEl.style.display = 'none';
        }
        
        const nisLabelEl = document.getElementById('m-nis-label');
        const nisValueEl = document.getElementById('m-nis');
        
        if (tipe === 'guru') {
            nisLabelEl.textContent = 'NIP';
            nisValueEl.textContent = data.nip || data.nis || '-'; 
        } else if (tipe === 'alumni') {
            nisLabelEl.textContent = 'No. Perpus'; 
            nisValueEl.textContent = data.nis || '-'; 
        } else if (tipe === 'non-32') {
            let idToShow = data.nip || data.nisn || data.nis || '-';
            let labelToShow = 'ID';
            if (data.nip) labelToShow = 'NIP';
            else if (data.nisn) labelToShow = 'NISN';
            else if (data.nis) labelToShow = 'No. Perpus/ID';
            
            nisLabelEl.textContent = labelToShow;
            nisValueEl.textContent = idToShow;
        } else { // Siswa
            nisLabelEl.textContent = 'NIS';
            nisValueEl.textContent = data.nis || '-';
        }

        document.getElementById('m-idhc').textContent = data.id_hc || '(Belum Ada)';
        document.getElementById('m-foto').src = data.foto || 'https://placehold.co/80x80/e2e8f0/1e293b?text=No+Img';

        // --- INI ADALAH LOGIKA PENGISI FORM ---
        let nisVal = '';
        let perpusVal = '';

        if (tipe === 'siswa-aktif') {
            nisVal = data.nis || ''; // data.nis adalah NIS
        } else if (tipe === 'alumni') {
            perpusVal = data.nis || ''; // data.nis adalah No. Perpus
        } else if (tipe === 'non-32') {
            perpusVal = data.nis || ''; // data.nis adalah No. Perpus/ID Lain
        }
        // Untuk 'guru', biarkan kosong, NIP diisi di bawah
        
        // Mengisi semua field
        document.getElementById('edit-nis').value = nisVal;
        document.getElementById('edit-perpus').value = perpusVal;
        document.getElementById('edit-nisn').value = data.nisn || '';
        document.getElementById('edit-nip').value = data.nip || '';
        // --- BATAS LOGIKA PENGISI FORM ---

        // Mengisi form "Data Personal"
        document.getElementById('edit-tglLahir').value = data.tanggalLahir || '';
        let nohp = data.nohp || '';
        let kodeHp = '+62';
        if (nohp.startsWith('0')) nohp = nohp.substring(1); 
        else if (nohp.startsWith('62')) nohp = nohp.substring(2);
        document.getElementById('edit-nohp').value = nohp;
        document.getElementById('edit-kode-hp').value = kodeHp;
        
        document.getElementById('edit-kelas').value = data.kelas || '';
        document.getElementById('edit-angkatan').value = data.angkatan || '';
        document.getElementById('edit-lulus').value = data.tahunLulus || '';
        document.getElementById('edit-email').value = data.email || '';
        document.getElementById('edit-jabatan').value = data.jabatan || '';
        document.getElementById('edit-tipe').value = tipe; 
        
        const ttdPreviewContainer = document.getElementById('ttd-preview-container');
        if (data.tandaTanganURL && data.tandaTanganURL.includes('thumbnail')) {
            document.getElementById('ttd-preview').src = data.tandaTanganURL;
            ttdPreviewContainer.style.display = 'block';
        } else {
            ttdPreviewContainer.style.display = 'none';
        }
        
        const fotoPreviewContainer = document.getElementById('foto-existing-preview');
        if (data.foto && data.foto.includes('thumbnail')) {
            fotoPreviewContainer.querySelector('img').src = data.foto;
            fotoPreviewContainer.style.display = 'block';
        } else {
            fotoPreviewContainer.style.display = 'none';
        }
        
        applyFieldRestrictions(tipe); // Memanggil fungsi pembatasan
        document.getElementById('tool-generate-idhc').style.display = (!data.id_hc || data.id_hc.trim() === '') ? 'block' : 'none';
        document.getElementById('member-card').style.display = 'block';
        document.getElementById('tools-container').style.display = 'grid';
        stopScanner();
        stopWebcam();
        signaturePad.clear();
        clearFotoPreview(false);
    }
        
        const nisLabelEl = document.getElementById('m-nis-label');
        const nisValueEl = document.getElementById('m-nis');
        
        if (tipe === 'guru') {
            nisLabelEl.textContent = 'NIP';
            nisValueEl.textContent = data.nip || data.nis || '-'; 
        } else if (tipe === 'alumni') {
            nisLabelEl.textContent = 'No. Perpus'; 
            nisValueEl.textContent = data.nis || '-'; 
        } else if (tipe === 'non-32') {
            let idToShow = data.nip || data.nisn || data.nis || '-';
            let labelToShow = 'ID';
            if (data.nip) labelToShow = 'NIP';
            else if (data.nisn) labelToShow = 'NISN';
            else if (data.nis) labelToShow = 'No. Perpus/ID';
            
            nisLabelEl.textContent = labelToShow;
            nisValueEl.textContent = idToShow;
        } else { // Siswa
            nisLabelEl.textContent = 'NIS';
            nisValueEl.textContent = data.nis || '-';
        }

        document.getElementById('m-idhc').textContent = data.id_hc || '(Belum Ada)';
        document.getElementById('m-foto').src = data.foto || 'https://placehold.co/80x80/e2e8f0/1e293b?text=No+Img';

        // --- PERBAIKAN: Logika baru untuk mengisi form "Perbaikan Nomor ID" ---
        let nisVal = '';
        let perpusVal = '';

        if (tipe === 'siswa-aktif') {
            nisVal = data.nis || ''; // data.nis adalah NIS
        } else if (tipe === 'alumni') {
            perpusVal = data.nis || ''; // data.nis adalah No. Perpus
        } else if (tipe === 'non-32') {
            perpusVal = data.nis || ''; // data.nis adalah No. Perpus/ID Lain
        }
        // Untuk 'guru', nisVal and perpusVal tetap '' (kosong), NIP akan diisi di bawah
        
        // Selalu isi semua data yang ada, biarkan applyFieldRestrictions yang menonaktifkan
        document.getElementById('edit-nis').value = nisVal;
        document.getElementById('edit-perpus').value = perpusVal;
        document.getElementById('edit-nisn').value = data.nisn || '';
        document.getElementById('edit-nip').value = data.nip || '';
        // --- BATAS PERBAIKAN ---

        // Mengisi form "Data Personal"
        document.getElementById('edit-tglLahir').value = data.tanggalLahir || '';
        let nohp = data.nohp || '';
        let kodeHp = '+62';
        if (nohp.startsWith('0')) nohp = nohp.substring(1); 
        else if (nohp.startsWith('62')) nohp = nohp.substring(2);
        document.getElementById('edit-nohp').value = nohp;
        document.getElementById('edit-kode-hp').value = kodeHp;
        
        document.getElementById('edit-kelas').value = data.kelas || '';
        document.getElementById('edit-angkatan').value = data.angkatan || '';
        document.getElementById('edit-lulus').value = data.tahunLulus || '';
        document.getElementById('edit-email').value = data.email || '';
        document.getElementById('edit-jabatan').value = data.jabatan || '';
        document.getElementById('edit-tipe').value = tipe; 
        
        const ttdPreviewContainer = document.getElementById('ttd-preview-container');
        if (data.tandaTanganURL && data.tandaTanganURL.includes('thumbnail')) {
            document.getElementById('ttd-preview').src = data.tandaTanganURL;
            ttdPreviewContainer.style.display = 'block';
        } else {
            ttdPreviewContainer.style.display = 'none';
        }
        
        const fotoPreviewContainer = document.getElementById('foto-existing-preview');
        if (data.foto && data.foto.includes('thumbnail')) {
            fotoPreviewContainer.querySelector('img').src = data.foto;
            fotoPreviewContainer.style.display = 'block';
        } else {
            fotoPreviewContainer.style.display = 'none';
        }
        
        applyFieldRestrictions(tipe);
        document.getElementById('tool-generate-idhc').style.display = (!data.id_hc || data.id_hc.trim() === '') ? 'block' : 'none';
        document.getElementById('member-card').style.display = 'block';
        document.getElementById('tools-container').style.display = 'grid';
        stopScanner();
        stopWebcam();
        signaturePad.clear();
        clearFotoPreview(false);
    }

    function hideAllTools() {
        document.getElementById('member-card').style.display = 'none';
        document.getElementById('tools-container').style.display = 'none';
        CURRENT_MEMBER = null;
    }

    // --- 3. LOGIKA SCANNER ---
    function startScanner(targetField) {
        scanTargetField = targetField;
        document.getElementById('scanner-modal').style.display = 'flex';
        if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
        
        html5QrCode.start(
            { facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText, decodedResult) => { html5QrCode.pause(); handleScanResult(decodedText); },
            (errorMessage) => { /* scanning... */ }
        ).catch((err) => { showStatus("error", "Error Kamera", err.message); stopScanner(); });
    }
    
    async function handleScanResult(id) {
        showStatus("load", "Memvalidasi hasil scan...");
        id = id.trim();
        const len = id.length;
        let detectedField = null;

        if (len === 7) detectedField = 'edit-nis';
        else if (len === 10) detectedField = 'edit-nisn';
        else if (len === 18) detectedField = 'edit-nip';
        else if (len >= 6 && len <= 9) detectedField = 'edit-perpus';
        
        const finalField = scanTargetField || detectedField;
        let errorMsg = null;

        if (scanTargetField && detectedField !== scanTargetField) {
            errorMsg = detectedField ? `Hasil scan (${len} digit) terdeteksi sebagai ${detectedField}, tapi Anda memindai untuk ${scanTargetField}.` : `Hasil scan (${len} digit) tidak cocok dengan format ${scanTargetField}.`;
        } else if (!finalField) {
            errorMsg = `ID tidak dikenal (${len} digit).`;
        } else if (document.getElementById(finalField).disabled) {
            errorMsg = `ID terdeteksi, tapi field tersebut non-aktif untuk tipe anggota ini.`;
        }

        await new Promise(r => setTimeout(r, 700));
        
        if (errorMsg) {
            showStatus("error", "Scan Gagal", errorMsg, () => { if (html5QrCode) html5QrCode.resume(); });
        } else {
            showStatus("success", "Scan Berhasil", `ID ${id} akan dimasukkan.`, () => {
                document.getElementById(finalField).value = id;
                stopScanner();
            });
        }
    }

    function stopScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => { document.getElementById('scanner-modal').style.display = 'none'; })
                            .catch(err => console.log("Gagal stop scanner", err));
        } else {
            document.getElementById('scanner-modal').style.display = 'none';
        }
        scanTargetField = null;
    }
    
    // --- 4. PEMBATASAN FIELD (SESUAI ATURAN BARU) ---
    function applyFieldRestrictions(tipe) {
        
        // 1. Definisikan semua elemen field dan tombol scannya
        const fields = {
            // Data Personal
            kelas: [document.getElementById('edit-kelas')],
            angkatan: [document.getElementById('edit-angkatan')],
            lulus: [document.getElementById('edit-lulus')],
            jabatan: [document.getElementById('edit-jabatan')],
            // Nomor ID
            nis: [document.getElementById('edit-nis'), document.getElementById('btn-scan-nis')],
            nisn: [document.getElementById('edit-nisn'), document.getElementById('btn-scan-nisn')],
            nip: [document.getElementById('edit-nip'), document.getElementById('btn-scan-nip')],
            perpus: [document.getElementById('edit-perpus'), document.getElementById('btn-scan-perpus')]
        };

        // Helper untuk (de)aktivasi
        const setDisabled = (fieldGroup, disabled) => {
            fieldGroup.forEach(el => el.disabled = disabled);
        };

        // 2. Nonaktifkan semua field yang bisa dibatasi terlebih dahulu
        Object.values(fields).forEach(group => setDisabled(group, true));
        
        // 3. Aktifkan field berdasarkan tipe
        tipe = (tipe || 'siswa-aktif').toLowerCase();

        if (tipe === 'siswa-aktif') {
            // Aktifkan Data Personal
            setDisabled(fields.kelas, false);
            setDisabled(fields.angkatan, false);
            
            // Aktifkan Nomor ID (sesuai aturan baru)
            setDisabled(fields.nis, false);
            setDisabled(fields.nisn, false);

        } else if (tipe === 'alumni') {
            // Aktifkan Data Personal
            setDisabled(fields.lulus, false);

            // Aktifkan Nomor ID (sesuai aturan baru)
            setDisabled(fields.nisn, false);
            setDisabled(fields.perpus, false);

        } else if (tipe === 'guru') {
            // Aktifkan Data Personal
            setDisabled(fields.jabatan, false);

            // Aktifkan Nomor ID (sesuai aturan baru)
            setDisabled(fields.nip, false);

        } else if (tipe === 'non-32') {
            // Aktifkan Data Personal
            setDisabled(fields.jabatan, false);

            // Aktifkan Nomor ID (sesuai aturan baru)
            setDisabled(fields.nisn, false);
            setDisabled(fields.nip, false);
            setDisabled(fields.perpus, false);
        }
        
        // Selalu aktifkan field yang umum
        document.getElementById('edit-tglLahir').disabled = false;
        document.getElementById('edit-kode-hp').disabled = false;
        document.getElementById('edit-nohp').disabled = false;
        document.getElementById('edit-email').disabled = false;
    }
    
    // --- 5. FITUR KAMERA & CROP ---
    function toggleWebcam() {
        if (webcamStream) stopWebcam();
        else startWebcam();
    }

    async function startWebcam() {
        try {
            webcamStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
            document.getElementById('webcam-container').style.display = 'block';
            document.getElementById('webcam-preview').srcObject = webcamStream;
            document.getElementById('btn-toggle-webcam').textContent = "‚èπÔ∏è Tutup Kamera";
            document.getElementById('btn-toggle-webcam').classList.add('btn-danger');
            document.getElementById('btn-pilih-file').disabled = true;
            clearFotoPreview(false, false);
        } catch (err) {
            showStatus("error", "Kamera Gagal", "Tidak bisa mengakses kamera. Pastikan Anda memberi izin.");
            console.error("Error webcam:", err);
        }
    }

    function stopWebcam() {
        if (webcamStream) {
            webcamStream.getTracks().forEach(track => track.stop());
            webcamStream = null;
        }
        document.getElementById('webcam-container').style.display = 'none';
        document.getElementById('btn-toggle-webcam').textContent = "üì∑ Guna Kamera";
        document.getElementById('btn-toggle-webcam').classList.remove('btn-danger');
        document.getElementById('btn-pilih-file').disabled = false;
    }
    
    function clearFotoPreview(stopCam = true, showExisting = true) {
         if (stopCam) stopWebcam();
         document.getElementById('foto-preview-wrapper').style.display = 'none';
         document.getElementById('foto-preview').src = '';
         document.getElementById('foto-input').value = '';
         document.getElementById('btn-upload-foto').disabled = true;
         currentPhotoBlob = null;
         if (showExisting && CURRENT_MEMBER && CURRENT_MEMBER.foto) {
             document.getElementById('foto-existing-preview').style.display = 'block';
         }
    }
    
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > (MAX_FILE_SIZE * 5)) { // 5MB limit pre-crop
            showStatus("error", "File Terlalu Besar", `Ukuran file ${(file.size / 1024 / 1024).toFixed(2)}MB. Batas maks 5MB untuk di-crop.`);
            e.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('cropper-image').src = event.target.result;
            document.getElementById('cropper-modal').style.display = 'flex';
            if(cropper) cropper.destroy();
            cropper = new Cropper(document.getElementById('cropper-image'), {
                aspectRatio: 1 / 1,
                viewMode: 1,
            });
        };
        reader.readAsDataURL(file);
    }
    
    function captureFoto() {
        const video = document.getElementById('webcam-preview');
        const canvas = document.getElementById('webcam-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        stopWebcam();
        
        document.getElementById('cropper-image').src = canvas.toDataURL('image/jpeg');
        document.getElementById('cropper-modal').style.display = 'flex';
        if(cropper) cropper.destroy();
        cropper = new Cropper(document.getElementById('cropper-image'), {
            aspectRatio: 1 / 1,
            viewMode: 1,
        });
    }
    
    function closeCropper() {
        document.getElementById('cropper-modal').style.display = 'none';
        document.getElementById('foto-input').value = '';
        if(cropper) cropper.destroy();
    }
    
    function saveCroppedImage() {
        if (!cropper) return;
        cropper.getCroppedCanvas({
            width: 512, height: 512,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        }).toBlob(blob => {
            if (blob.size > MAX_FILE_SIZE) {
                showStatus("error", "Foto Terlalu Besar", `Ukuran setelah di-crop ${(blob.size / 1024 / 1024).toFixed(2)}MB. Batas maks 1MB.`);
                return;
            }
            currentPhotoBlob = blob;
            document.getElementById('foto-preview').src = URL.createObjectURL(blob);
            document.getElementById('foto-preview-wrapper').style.display = 'block';
            document.getElementById('foto-existing-preview').style.display = 'none';
            document.getElementById('btn-upload-foto').disabled = false;
            closeCropper();
        }, 'image/png', 0.9);
    }


    // --- 6. AKSI SIMPAN & UPLOAD ---
    
    async function simpanDataPersonal() {
        showStatus("confirm", "Konfirmasi Simpan", "Yakin ingin memperbarui data personal anggota ini?", async () => {
            showStatus("load", "Menyimpan Data...");
            
            let nohp = document.getElementById('edit-nohp').value.trim();
            let kodeHp = document.getElementById('edit-kode-hp').value;
            if (nohp.length > 5 && !nohp.startsWith('0') && kodeHp === '+62') {
                nohp = '0' + nohp;
            } else if (kodeHp !== '+62') {
                nohp = kodeHp + nohp;
            }
            
            const payload = {
                token: hc32_getSession().token, nisTarget: CURRENT_MEMBER.nis,
                kelas: document.getElementById('edit-kelas').value,
                angkatan: document.getElementById('edit-angkatan').value,
                nohp: nohp,
                email: document.getElementById('edit-email').value.trim(),
                jabatan: document.getElementById('edit-jabatan').value.trim(),
                tahunLulus: document.getElementById('edit-lulus').value.trim(),
                tglLahir: document.getElementById('edit-tglLahir').value.trim()
            };
            const res = await hc32_post('updateDataAnggotaLengkap', payload);
            await new Promise(r => setTimeout(r, 700)); 
            showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "Berhasil Disimpan" : "Gagal", res.message, () => {
                if (res.status === 'ok') getAnggotaPenuh(CURRENT_MEMBER.nis); 
            });
        });
    }

    async function simpanPerbaikanID() {
        showStatus("confirm", "Konfirmasi Simpan", "Yakin ingin memperbarui Nomor ID anggota ini?", async () => {
            showStatus("load", "Menyimpan ID...");
            
            const res = await hc32_post('simpanPerbaikanID', {
                token: hc32_getSession().token, 
                nisTarget: CURRENT_MEMBER.nis,
                nisBaru: document.getElementById('edit-nis').value.trim(),
                perpusBaru: document.getElementById('edit-perpus').value.trim(),
                nisnBaru: document.getElementById('edit-nisn').value.trim(),
                nipBaru: document.getElementById('edit-nip').value.trim()
            });
            
            await new Promise(r => setTimeout(r, 700));
            showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "Berhasil Disimpan" : "Gagal", res.message, () => {
                 if (res.status === 'ok') {
                     const nisBaru = document.getElementById('edit-nis').value.trim();
                     const perpusBaru = document.getElementById('edit-perpus').value.trim();
                     getAnggotaPenuh(nisBaru || perpusBaru || CURRENT_MEMBER.nis); 
                 }
            });
        });
    }

    async function uploadFoto() {
        if (!currentPhotoBlob) {
            showStatus("error", "Foto Belum Dipilih", "Silakan pilih file atau ambil foto dengan kamera.");
            return;
        }
        showStatus("confirm", "Konfirmasi Upload", "Yakin ingin mengupload foto ini?", () => {
            const reader = new FileReader();
            reader.readAsDataURL(currentPhotoBlob);
            reader.onloadend = async () => {
                const base64 = reader.result;
                showStatus("load", "Mengupload Foto...");
                const res = await hc32_post('uploadFotoSusulan', {
                    token: hc32_getSession().token, nisTarget: CURRENT_MEMBER.nis,
                    fotoBase64: base64
                });
                await new Promise(r => setTimeout(r, 700));
                showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "Upload Berhasil" : "Gagal", res.message, () => {
                    if (res.status === 'ok') {
                        document.getElementById('m-foto').src = res.url;
                        clearFotoPreview(false, true);
                        document.getElementById('foto-existing-preview').querySelector('img').src = res.url;
                    }
                });
            };
        });
    }

    async function simpanTandaTangan() {
        if (signaturePad.isEmpty()) {
            showStatus("error", "Tanda Tangan Kosong", "Silakan bubuhkan tanda tangan di kotak yang tersedia.");
            return;
        }
        showStatus("confirm", "Konfirmasi Simpan", "Simpan tanda tangan ini? (Akan menimpa TTD lama jika ada)", async () => {
            showStatus("load", "Menyimpan TTD...");
            const base64 = signaturePad.toDataURL('image/png');
            const res = await hc32_post('uploadTtdSusulan', {
                token: hc32_getSession().token, nisTarget: CURRENT_MEMBER.nis,
                ttdBase64: base64
            });
            await new Promise(r => setTimeout(r, 700));
            showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "TTD Disimpan" : "Gagal", res.message, () => {
                if (res.status === 'ok') {
                    signaturePad.clear();
                    document.getElementById('ttd-preview').src = res.url; 
                    document.getElementById('ttd-preview-container').style.display = 'block';
                }
            });
        });
    }
    
    async function simpanTipeKeanggotaan() {
        const tipeBaru = document.getElementById('edit-tipe').value;
        showStatus("confirm", "Konfirmasi Ganti Tipe", `Yakin ingin mengubah tipe anggota ini menjadi "${tipeBaru}"?`, async () => {
            showStatus("load", "Mengubah Tipe...");
            const res = await hc32_post('updateAnggotaTipe', {
                token: hc32_getSession().token, 
                nis: CURRENT_MEMBER.nis,
                tipe: tipeBaru
            });
            await new Promise(r => setTimeout(r, 700));
            showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "Tipe Diubah" : "Gagal", res.message, () => {
                if (res.status === 'ok') getAnggotaPenuh(CURRENT_MEMBER.nis); 
            });
        });
    }

    async function generateIDHC() {
        showStatus("confirm", "Konfirmasi Generate", "Yakin ingin membuat ID HC baru untuk anggota ini?", async () => {
            showStatus("load", "Membuat ID...");
            const res = await hc32_post('generateIdHcSusulan', {
                token: hc32_getSession().token, nisTarget: CURRENT_MEMBER.nis
            });
            await new Promise(r => setTimeout(r, 700));
            showStatus(res.status === 'ok' ? "success" : "error", res.status === 'ok' ? "ID HC Dibuat" : "Gagal", res.message, () => {
                if (res.status === 'ok') {
                    document.getElementById('m-idhc').textContent = res.id_hc;
                    document.getElementById('tool-generate-idhc').style.display = 'none'; 
                }
            });
        });
    }
</script>
</body>
</html>
