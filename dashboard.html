<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin HC 32</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root {
            /* Warna dari Brand Guide */
            --hc-blue: #1a4787;
            --hc-toska: #0f8a94;
            --hc-dark: #2e2e2e;
            --hc-green: #15a256;
            --hc-red: #d30e14;
            --hc-bg: #e7e9ea;
            --hc-blue-light-bg: rgba(26, 71, 135, 0.08);
        }

        @keyframes hcspin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        body {
            font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: var(--hc-dark);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        /* Loading Spinner */
        #hc32-loading-overlay {
            position: fixed; inset: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .hc-loader {
            position: relative; width: 64px; height: 64px;
            display: flex; align-items: center; justify-content: center;
        }
        .hc-loader-spinner {
            position: absolute; inset: 0;
            border-radius: 50%;
            border: 5px solid var(--hc-blue);
            border-top-color: var(--hc-toska);
            animation: hcspin 1s linear infinite;
        }
        .hc-loader-logo {
            width: 44px; height: 44px; border-radius: 50%;
        }

        /* Sidebar Navigasi */
        aside {
            width: 240px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
            position: fixed;
            inset: 0 auto 0 0;
            z-index: 50;
            transition: transform 0.3s ease;
        }
        .aside-header {
            display: flex; align-items: center; gap: 10px;
            padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;
        }
        .aside-logo { width: 40px; height: 40px; border-radius: 50%; }
        .aside-title { font-size: 14px; font-weight: 600; color: var(--hc-dark); }
        .aside-subtitle { font-size: 12px; color: #64748b; }
        
        aside nav { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
        .nav-item {
            display: block; text-decoration: none; color: #334155;
            font-size: 14px; font-weight: 500; padding: 8px 12px;
            border-radius: 6px; transition: all 0.2s ease;
        }
        .nav-item:hover { background-color: #f1f5f9; }
        .nav-item.active {
            background-color: var(--hc-blue-light-bg);
            color: var(--hc-blue);
            font-weight: 600;
        }

        /* Konten Utama */
        main {
            flex-grow: 1;
            padding: 32px;
            overflow-y: auto;
            margin-left: 240px; /* Lebar sidebar */
        }
        
        /* Header Halaman (di dalam Main) */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 24px 0;
        }
        #btn-open-sidebar {
            display: none;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }
        
        .page-title {
            font-size: 28px; font-weight: 700;
            color: var(--hc-dark); margin: 0 0 4px 0;
        }
        .page-subtitle { font-size: 16px; color: #475569; margin: 0; }

        /* Grid Dashboard (BARU) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .content-section {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(15, 23, 42, .05);
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--hc-dark);
            margin: 0 0 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title a, .view-all-link {
            font-size: 13px;
            font-weight: 500;
            color: var(--hc-blue);
            text-decoration: none;
        }
        
        /* Style List Preview */
        .preview-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            /* Tambahkan ini agar list bisa di-scroll jika terlalu panjang */
            max-height: 400px;
            overflow-y: auto;
        }
        .preview-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        .preview-item:last-child { border-bottom: none; padding-bottom: 0; }
        .preview-item-icon {
            width: 36px; height: 36px;
            border-radius: 50%;
            background-color: var(--hc-blue-light-bg);
            color: var(--hc-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
            font-weight: 600;
        }
        /* Style untuk Foto (BARU) */
        .preview-item-foto {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
        }
        .preview-item-img-posting {
             width: 36px;
             height: 36px;
             border-radius: 6px;
             object-fit: cover;
             flex-shrink: 0;
             border: 1px solid #e2e8f0;
        }

        .preview-item-info { flex: 1; min-width: 0; }
        .preview-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--hc-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .preview-item-sub {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            white-space: normal; /* Izinkan sub-judul untuk wrap */
        }
        .placeholder-text {
            font-size: 13px;
            color: #94a3b8;
            text-align: center;
            padding: 10px 0;
        }

        /* Responsif */
        @media (max-width: 900px) {
            aside {
                transform: translateX(-100%);
            }
            aside.open {
                transform: translateX(0);
            }
            main {
                margin-left: 0;
            }
            #btn-open-sidebar {
                display: inline-flex;
            }
        }
        
        @media (max-width: 768px) {
            main {
                padding: 20px 16px;
            }
        }
    </style>
</head>
<body>

    <div id="hc32-loading-overlay">
        <div class="hc-loader">
            <div class="hc-loader-spinner"></div>
            <img src="https://lh3.googleusercontent.com/a/ACg8ocL8As-y-kYtJrh1Q-z-x-nF8YV3-i-X-gYqYgYqYgYq=s96-c" class="hc-loader-logo" alt="Logo HC">
        </div>
    </div>

    <aside id="sidebar">
        <div class="aside-header">
            <img src="https://lh3.googleusercontent.com/a/ACg8ocL8As-y-kYtJrh1Q-z-x-nF8YV3-i-X-gYqYgYqYgYq=s96-c" alt="Logo HC" class="aside-logo">
            <div>
                <div class="aside-title">Admin HC 32</div>
                <div class="aside-subtitle" id="admin-user-name">Memuat...</div>
            </div>
        </div>
        <nav>
            <a href="dashboard.html" class="nav-item active">Dashboard</a>
            <a href="presensi.html" class="nav-item">Presensi</a>
            <a href="admin-agenda.html" class="nav-item">Agenda</a>
            <a href="admin-posting.html" class="nav-item">Posting</a>
            <a href="admin-anggota.html" class="nav-item">Anggota</a>
            <a href="admin-kepengurusan.html" class="nav-item">Kepengurusan</a>
            <a href="#" id="logout-btn" class="nav-item" style="color: var(--hc-red);">Logout</a>
        </nav>
    </aside>

    <main>
        <header class="page-header">
            <div>
                <h1 class="page-title">Dashboard Admin</h1>
                <p class="page-subtitle">Ringkasan aktivitas terbaru di HC 32.</p>
            </div>
            <button id="btn-open-sidebar" aria-label="Buka menu">☰</button>
        </header>

        <div class="dashboard-grid">
            
            <section class="content-section">
                <h2 class="section-title">
                    Presensi Terbaru
                    <a href="presensi.html">Lihat Semua</a>
                </h2>
                <div id="preview-presensi" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    Anggota Terbaru
                    <a href="admin-anggota.html">Lihat Semua</a>
                </h2>
                <div id="preview-anggota" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    Agenda Terdekat
                    <a href="admin-agenda.html">Lihat Semua</a>
                </h2>
                <div id="preview-agenda" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

            <section class="content-section">
                <h2 class="section-title">
                    Postingan Terbaru
                    <a href="admin-posting.html">Lihat Semua</a>
                </h2>
                <div id="preview-posting" class="preview-list">
                    <p class="placeholder-text">Memuat...</p>
                </div>
            </section>

        </div>
    </main>

    <script>
        // Gunakan config.js
        const LOADER = document.getElementById("hc32-loading-overlay");
        let ADMIN_TOKEN = null;
        let ADMIN_NAMA = null;
        
        // 1. Validasi Sesi (DIPERBARUI)
        function validateSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlNama = urlParams.get('n'); // 'n' dari skrip login

            let session;

            if (urlToken && urlNama) {
                // === Skenario 1: Baru login, token ada di URL ===
                console.log("Token ditemukan di URL, menyimpan ke session...");
                // Simpan ke localStorage untuk refresh nanti
                hc32_saveSession(urlToken, urlNama); 
                
                // Bersihkan URL agar token tidak terlihat & tidak ter-bookmark
                window.history.replaceState({}, document.title, window.location.pathname); 
                
                session = { token: urlToken, nama: urlNama };

            } else {
                // === Skenario 2: Refresh halaman, cek localStorage ===
                console.log("Mencari token di localStorage...");
                session = hc32_getSession(); // Dari config.js
            }

            // === Skenario 3: Pengecekan Final ===
            if (!session || !session.token || !session.nama) {
                // Gagal total, tidak ada token di mana pun
                alert("Sesi tidak valid. Silakan login kembali.");
                // Redirect ke halaman login Google Sites
                window.location.href = "https://sites.google.com/view/history-club-32/keanggotaan/login-pengurus";
                return false;
            }

            // === Sukses ===
            // Set variabel global dari sesi yang ditemukan
            ADMIN_TOKEN = session.token;
            ADMIN_NAMA = session.nama;
            document.getElementById("admin-user-name").textContent = session.nama;
            return true;
        }

        // 2. Fungsi Render (DIPERBARUI SESUAI PERMINTAAN)

        /**
         * BARU: Menampilkan 15 presensi terbaru
         * (Foto, Nama, ID HC, Kelas)
         */
        function renderPreviewPresensi(data) {
            const container = document.getElementById("preview-presensi");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada presensi.</p>`; return;
            }
            container.innerHTML = "";
            // Ambil 15 terbaru
            data.slice(0, 15).forEach(p => { 
                const item = document.createElement("div");
                item.className = "preview-item";
                
                // Gunakan p.foto jika ada, jika tidak, pakai inisial
                const inisial = p.nama ? p.nama.charAt(0).toUpperCase() : 'HC';
                const fotoHTML = p.foto ? 
                    `<img src="${p.foto}" alt="${p.nama}" class="preview-item-foto">` :
                    `<div class="preview-item-icon" style="background-color: #f1f5f9; color: #475569;">${inisial}</div>`;
                
                item.innerHTML = `
                    ${fotoHTML}
                    <div class="preview-item-info">
                        <div class="preview-item-title">${p.nama}</div>
                        <div class="preview-item-sub">ID: ${p.id_hc || '-'} • ${p.kelas || p.tipe || 'Lainnya'}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        /**
         * BARU: Menampilkan 15 anggota terbaru
         * (Foto, Nama, ID HC, Kelas)
         */
        function renderPreviewAnggota(data) {
            const container = document.getElementById("preview-anggota");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada anggota.</p>`; return;
            }
            container.innerHTML = "";
            // Urutkan berdasarkan timestamp (pendaftaran terbaru)
            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Ambil 15 terbaru
            data.slice(0, 15).forEach(p => {
                const item = document.createElement("div");
                item.className = "preview-item";
                
                // Gunakan p.foto jika ada, jika tidak, pakai inisial
                const inisial = p.nama ? p.nama.charAt(0).toUpperCase() : 'HC';
                const fotoHTML = p.foto ? 
                    `<img src="${p.foto}" alt="${p.nama}" class="preview-item-foto">` :
                    `<div class="preview-item-icon" style="background-color: var(--hc-blue-light-bg); color: var(--hc-blue);">${inisial}</div>`;
                
                item.innerHTML = `
                    ${fotoHTML}
                    <div class="preview-item-info">
                        <div class="preview-item-title">${p.nama}</div>
                        <div class="preview-item-sub">ID: ${p.id_hc || '-'} • ${p.kelas || p.tipe || 'Lainnya'}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        /**
         * BARU: Menampilkan 5 agenda terdekat dengan detail
         * (Nama, Tanggal, Waktu, Tempat, Kategori, Status)
         */
        function renderPreviewAgenda(data) {
            const container = document.getElementById("preview-agenda");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada agenda.</p>`; return;
            }
            container.innerHTML = "";
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Filter hanya agenda yang akan datang (Agenda Terdekat)
            const upcoming = data
                .filter(p => new Date(p.tanggal) >= today && p.status !== 'draft')
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if(upcoming.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Tidak ada agenda terdekat.</p>`; return;
            }
            
            // Ambil 5 terdekat
            upcoming.slice(0, 5).forEach(p => {
                const item = document.createElement("div");
                item.className = "preview-item";
                const tgl = new Date(p.tanggal);
                
                // Styling untuk status
                let statusColor = '#64748b'; // default
                let statusText = p.status ? p.status.charAt(0).toUpperCase() + p.status.slice(1) : 'Status-';
                if (p.status === 'aktif') {
                    statusColor = 'var(--hc-green)';
                } else if (p.status === 'dibatalkan') {
                    statusColor = 'var(--hc-red)';
                }

                item.innerHTML = `
                    <div class="preview-item-icon" style="background-color: rgba(15, 138, 148, 0.1); color: var(--hc-toska);">
                        ${tgl.getDate()}
                    </div>
                    <div class="preview-item-info">
                        <div class="preview-item-title">${p.judul}</div>
                        <div class="preview-item-sub">
                            ${tgl.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})} | ${p.waktu || 'Waktu-'} | ${p.tempat || 'Tempat-'}
                            <br>
                            <strong style="color: ${statusColor};">${statusText}</strong> (${p.kategori || 'Kategori-'})
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        /**
         * BARU: Menampilkan 3 postingan terbaru
         * (Dengan gambar preview)
         */
        function renderPreviewPosting(data) {
            const container = document.getElementById("preview-posting");
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="placeholder-text">Belum ada postingan.</p>`; return;
            }
            container.innerHTML = "";
            // Urutkan berdasarkan tanggal (terbaru dulu)
            data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            // Ambil 3 terbaru
            data.slice(0, 3).forEach(p => {
                const item = document.createElement("div");
                item.className = "preview-item";
                
                // Gunakan p.gambar jika ada, jika tidak, pakai inisial '!'
                const gambarHTML = p.gambar ? 
                    `<img src="${p.gambar}" alt="${p.judul}" class="preview-item-img-posting">` :
                    `<div class="preview-item-icon" style="background-color: rgba(211, 14, 20, 0.05); color: var(--hc-red);">!</div>`;

                item.innerHTML = `
                    ${gambarHTML}
                    <div class="preview-item-info">
                        <div class="preview-item-title">${p.judul}</div>
                        <div class="preview-item-sub">${p.kategori} • ${new Date(p.tanggal).toLocaleDateString('id-ID')}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 3. Muat Semua Data (Sudah Benar)
        async function loadAllPreviews() {
            const [
                presensiData, 
                anggotaData, 
                agendaData, 
                postingData
            ] = await Promise.all([
                hc32_post("getPresensiDashboard", { token: ADMIN_TOKEN }),
                hc32_post("listAnggotaAdmin", { token: ADMIN_TOKEN }),  
                hc32_post("listKegiatanAdmin", { token: ADMIN_TOKEN }),  
                hc32_post("listPostingAdmin", { token: ADMIN_TOKEN })   
            ]);

            if (!presensiData || !anggotaData || !agendaData || !postingData) {
                console.error("Gagal memuat sebagian data, kemungkinan token salah.");
                // Fungsi hc32_post di config.js akan otomatis redirect jika token salah
                return;
            }

            // Render setiap bagian
            renderPreviewPresensi(presensiData.data);
            renderPreviewAnggota(anggotaData.data);
            renderPreviewAgenda(agendaData.data);
            renderPreviewPosting(postingData.data);
        }

        // 4. Init (Sudah Benar dan Diperbaiki)
        document.addEventListener("DOMContentLoaded", () => {
            // validateSession() sekarang menangani semua logika token
            if (validateSession()) {
                // Jika sesi valid, muat data
                loadAllPreviews().finally(() => {
                    LOADER.style.display = 'none'; // Sembunyikan loading
                });
            }
            // Jika sesi tidak valid, validateSession() sudah mengurus redirect
            
            document.getElementById("logout-btn").addEventListener("click", (e) => {
                e.preventDefault();
                hc32_logout(); // Hapus session & redirect
            });

            // Handle sidebar mobile
            const sb = document.getElementById("sidebar");
            document.getElementById("btn-open-sidebar").addEventListener("click", () => sb.classList.toggle("open"));
        });
    </script>
</body>
</html>
