<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Admin HC 32</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root {
            --hc-blue: #1a4787;
            --hc-toska: #0f8a94;
            --hc-dark: #2e2e2e;
            --hc-green: #15a256;
            --hc-red: #d30e14;
            --hc-bg: #e7e9ea;
            --hc-blue-light-bg: rgba(26, 71, 135, 0.08);
            --hc-presensi-bg: rgba(21, 162, 86, 0.1); 
            --hc-presensi-border: rgba(21, 162, 86, 0.3);
        }

        @keyframes hcspin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        body {
            font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: var(--hc-dark);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- Loading & Sidebar --- */
        #hc32-loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .hc-loader { position: relative; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; }
        .hc-loader-spinner { position: absolute; inset: 0; border-radius: 50%; border: 5px solid var(--hc-blue); border-top-color: var(--hc-toska); animation: hcspin 1s linear infinite; }
        .hc-loader-logo { width: 44px; height: 44px; border-radius: 50%; }
        
        aside { width: 240px; background: #ffffff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; position: fixed; inset: 0 auto 0 0; z-index: 50; transition: transform 0.3s ease; }
        .aside-header { display: flex; align-items: center; gap: 10px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0; }
        .aside-logo { width: 40px; height: 40px; border-radius: 50%; }
        aside nav { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
        .nav-item { display: block; text-decoration: none; color: #334155; font-size: 14px; font-weight: 500; padding: 8px 12px; border-radius: 6px; transition: all 0.2s ease; }
        .nav-item:hover { background-color: #f1f5f9; }
        .nav-item.active { background-color: var(--hc-blue-light-bg); color: var(--hc-blue); font-weight: 600; }
        
        main { flex-grow: 1; padding: 32px; overflow-y: auto; margin-left: 240px; }
        header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 24px 0; }
        #btn-open-sidebar { display: none; background: white; border: 1px solid #cbd5e1; border-radius: 6px; width: 36px; height: 36px; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; }
        .page-title { font-size: 28px; font-weight: 700; color: var(--hc-dark); margin: 0 0 4px 0; }
        .page-subtitle { font-size: 16px; color: #475569; margin: 0; }
        .content-section { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 24px; box-shadow: 0 4px 16px rgba(15, 23, 42, .05); margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 600; color: var(--hc-dark); margin: 0 0 16px 0; display: flex; justify-content: space-between; align-items: center; }

        /* --- Style Form --- */
        #agenda-form { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 20px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: 600; color: var(--hc-dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 9px 12px; font-size: 14px; font-family: 'Poppins', sans-serif; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--hc-blue); box-shadow: 0 0 0 2px var(--hc-blue-light-bg); }
        .form-group textarea { min-height: 80px; resize: vertical; }

        /* Time Dropdown Style */
        .time-group { display: flex; align-items: center; gap: 8px; }
        .time-group select { flex: 1; }

        /* Upload Foto Style */
        .file-upload-wrapper { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: border-color 0.2s; }
        .file-upload-wrapper:hover { border-color: var(--hc-blue); }
        #foto { display: none; } 
        #file-upload-text { font-size: 14px; color: #64748b; }
        #file-upload-text small { font-size: 12px; color: #94a3b8; display: block; }
        #foto-preview { max-width: 100%; max-height: 150px; border-radius: 6px; margin-top: 12px; border: 1px solid #e2e8f0; display: none; }
        
        .form-buttons { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #f1f5f9; padding-top: 16px; margin-top: 8px; }
        .btn-submit { background-color: var(--hc-green); color: white; padding: 10px 16px; border-radius: 6px; border:none; font-weight:600; cursor: pointer; }
        .btn-submit:hover { background-color: #128a4a; }
        .btn-submit.editing { background-color: var(--hc-blue); }
        .btn-cancel { background-color: #f1f5f9; color: var(--hc-dark); padding: 10px 16px; border-radius: 6px; border:none; font-weight:600; cursor: pointer; }

        /* --- Style Tabel --- */
        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        #agenda-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        #agenda-table th, #agenda-table td { padding: 10px 14px; text-align: left; font-size: 13px; border-bottom: 1px solid #e2e8f0; transition: background-color 0.3s ease; vertical-align: middle; }
        #agenda-table th { font-weight: 600; font-size: 12px; background-color: #f8fafc; color: #64748b; text-transform: uppercase; }
        #agenda-table tr:last-child td { border-bottom: none; }
        
        /* Highlight Presensi */
        #agenda-table tr.current-presensi td { background-color: var(--hc-presensi-bg); border-bottom-color: var(--hc-presensi-border); }
        
        .col-foto { width: 60px; padding: 6px 10px !important; }
        .table-foto-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #e2e8f0; }
        .table-foto-placeholder { width: 50px; height: 50px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 10px; }
        
        .col-judul { font-weight: 600; }
        .col-tanggal, .col-waktu { white-space: nowrap; }
        .col-status { text-transform: capitalize; }
        .col-aksi { width: 1%; white-space: nowrap; }

        .action-buttons { display: flex; gap: 8px; }
        .btn-action { font-size: 12px; font-weight: 500; padding: 4px 8px; border:none; border-radius: 4px; cursor:pointer; }
        .btn-action.presensi { background-color: var(--hc-blue); color: white; }
        .btn-action.presensi:hover { background-color: #123568; }
        .btn-action.presensi:disabled { background-color: var(--hc-green); cursor: default; }
        .btn-action.edit { background-color: #eef2ff; color: #4338ca; }
        .btn-action.edit:hover { background-color: #e0e7ff; }
        .btn-action.delete { background-color: #fee2e2; color: #b91c1c; }
        .btn-action.delete:hover { background-color: #fecaca; }
        
        .placeholder-text { font-size: 14px; color: #94a3b8; text-align: center; padding: 20px; }

        @media (max-width: 900px) {
            aside { transform: translateX(-100%); }
            aside.open { transform: translateX(0); }
            main { margin-left: 0; }
            #btn-open-sidebar { display: inline-flex; }
        }
        @media (max-width: 768px) {
            main { padding: 20px 16px; }
            #agenda-form { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="hc32-loading-overlay">
        <div class="hc-loader">
            <div class="hc-loader-spinner"></div>
            <img src="https://lh3.googleusercontent.com/a/ACg8ocL8As-y-kYtJrh1Q-z-x-nF8YV3-i-X-gYqYgYqYgYq=s96-c" class="hc-loader-logo" alt="Logo HC">
        </div>
    </div>

    <aside id="sidebar">
        <div class="aside-header">
             <img src="https://lh3.googleusercontent.com/d/1lAev2D5Pxp5Rt36iy4y0YMibEnYu5BgI" alt="Foto Admin" class="aside-logo" id="admin-foto-display">
            <div>
                <div style="font-weight: 700; color: var(--hc-blue);" id="admin-jabatan-display">Admin HC</div>
                <div style="font-size: 12px; color: #64748b;" id="admin-name-display">Memuat...</div>
            </div>
        </div>
        <nav>
            <a href="dashboard.html" class="nav-item">Dashboard</a>
            <a href="presensi.html" class="nav-item">Presensi</a>
            <a href="admin-agenda.html" class="nav-item active">Agenda</a>
            <a href="admin-posting.html" class="nav-item">Posting</a>
            <a href="admin-anggota.html" class="nav-item">Anggota</a>
            <a href="admin-kepengurusan.html" class="nav-item">Kepengurusan</a>
            <a href="perbaikan.html" class="nav-item">Perbaikan Data</a>
            <a href="#" id="logout-btn" class="nav-item" style="color: var(--hc-red);">Logout</a>
        </nav>
    </aside>
    
    <main>
        <header class="page-header">
            <div>
                <h1 class="page-title">Manajemen Agenda</h1>
                <p class="page-subtitle">Tambah, edit, dan hapus agenda kegiatan.</p>
            </div>
            <button id="btn-open-sidebar" aria-label="Buka menu">â˜°</button>
        </header>

        <section class="content-section" id="form-section">
            <h2 class="section-title" id="form-title">Formulir Agenda Baru</h2>
            
            <form id="agenda-form">
                <input type="hidden" id="edit-id" name="id">
            
                <div class="form-group full-width">
                    <label for="judul">Judul Agenda (Wajib)</label>
                    <input type="text" id="judul" name="judul" required>
                </div>

                <div class="form-group">
                    <label for="tanggal">Tanggal (Wajib)</label>
                    <input type="date" id="tanggal" name="tanggal" required>
                </div>
                
                <div class="form-group">
                    <label for="waktuMulai">Waktu (Opsional)</label>
                    <div class="time-group">
                        <select id="waktuMulai" name="waktuMulai">
                            <option value="">Mulai...</option>
                            </select>
                        <span>-</span>
                        <select id="waktuSelesai" name="waktuSelesai">
                            <option value="">Selesai...</option>
                            <option value="Selesai">Selesai</option>
                            </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="tempat">Tempat (Wajib)</label>
                    <select id="tempat" name="tempat" required>
                        <option value="">Pilih Tempat...</option>
                        <option value="Perpustakaan SMAN 32 Jakarta">Perpustakaan SMAN 32 Jakarta</option>
                        <option value="Ruang AV SMAN 32 Jakarta">Ruang AV SMAN 32 Jakarta</option>
                        <option value="Saung SMAN 32 Jakarta">Saung SMAN 32 Jakarta</option>
                        <option value="custom">Lainnya (Isi Sendiri)...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tempatCustom">Tempat Lainnya</label>
                    <input type="text" id="tempatCustom" name="tempatCustom" placeholder="Ketik nama tempat" style="display: none;">
                </div>

                <div class="form-group full-width">
                    <label for="deskripsi">Deskripsi Singkat (Wajib)</label>
                    <textarea id="deskripsi" name="deskripsi" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="kategori">Kategori</label>
                    <select id="kategori" name="kategori">
                        <option value="Pertemuan Reguler">Pertemuan Reguler</option>
                        <option value="Hari/Pertemuan Spesial">Hari/Pertemuan Spesial</option>
                        <option value="Rapat Pengurus">Rapat Pengurus</option>
                        <option value="Rapat Anggota">Rapat Anggota</option>
                        <option value="Lomba">Lomba</option>
                        <option value="Kunjungan Museum">Kunjungan Museum</option>
                        <option value="Kegiatan Luar Biasa">Kegiatan Luar Biasa</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="status">Status Editorial</label>
                    <select id="status" name="status">
                        <option value="aktif">Aktif (Tampil di publik)</option>
                        <option value="draft">Draft (Disimpan saja)</option>
                        <option value="dibatalkan">Dibatalkan</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label>Foto Agenda (Opsional, Maks 2MB)</label>
                    <label for="foto" class="file-upload-wrapper">
                        <span id="file-upload-text">
                            Klik untuk memilih file
                            <small>Format: JPG, PNG, WEBP. Ukuran maks 2MB.</small>
                        </span>
                        <img src="#" alt="Preview" id="foto-preview">
                    </label>
                    <input type="file" id="foto" name="foto" accept="image/jpeg, image/png, image/webp">
                </div>

                <div class="form-buttons">
                    <button type="button" id="cancel-btn" class="btn-cancel" style="display: none;">Batal</button>
                    <button type="submit" id="submit-btn" class="btn-submit">Simpan Agenda Baru</button>
                </div>
            </form>
        </section>

        <section class="content-section" id="list-section">
            <h2 class="section-title">Daftar Agenda</h2>
            <div class="table-wrapper">
                <table id="agenda-table">
                    <thead>
                        <tr>
                            <th class="col-foto">Foto</th>
                            <th class="col-judul">Judul</th>
                            <th class="col-tanggal">Tanggal</th>
                            <th class="col-waktu">Waktu</th>
                            <th>Tempat</th>
                            <th class="col-status">Status</th>
                            <th class="col-aksi">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="agenda-table-body">
                        </tbody>
                </table>
                <div id="agenda-placeholder">
                    <p class="placeholder-text">Memuat data...</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        const LOADER = document.getElementById("hc32-loading-overlay");
        let ADMIN_TOKEN = null;
        let ADMIN_NAMA = null;
        
        let allAgendaData = []; 
        let CURRENT_MEETING_JUDUL = null; 
        let selectedFotoBase64 = null; 
        const MAX_FILE_SIZE_MB = 2;
        
        // UI Elements
        const form = document.getElementById("agenda-form");
        const tableBody = document.getElementById("agenda-table-body");
        const placeholder = document.getElementById("agenda-placeholder");
        const submitBtn = document.getElementById("submit-btn");
        const cancelBtn = document.getElementById("cancel-btn"); 
        const formTitle = document.getElementById("form-title"); 
        const editIdInput = document.getElementById("edit-id");
        
        const tempatSelect = document.getElementById("tempat");
        const tempatCustomInput = document.getElementById("tempatCustom");
        const fotoInput = document.getElementById("foto");
        const fotoPreview = document.getElementById("foto-preview");
        const fotoUploadText = document.getElementById("file-upload-text");
        const waktuMulaiSelect = document.getElementById("waktuMulai");
        const waktuSelesaiSelect = document.getElementById("waktuSelesai");

        function validateSession() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('token')) {
                hc32_saveSession(urlParams.get('token'), urlParams.get('n'), urlParams.get('j'), urlParams.get('f'));
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            const s = hc32_getSession();
            if (!s || !s.token) {
                alert("Sesi tidak valid."); window.location.href = "https://sites.google.com/view/history-club-32/keanggotaan/login-pengurus";
                return false;
            }
            ADMIN_TOKEN = s.token; ADMIN_NAMA = s.nama;
            document.getElementById("admin-name-display").textContent = s.nama;
            document.getElementById("admin-jabatan-display").textContent = s.jabatan || 'Admin';
            document.getElementById("admin-foto-display").src = s.foto || 'https://lh3.googleusercontent.com/d/1lAev2D5Pxp5Rt36iy4y0YMibEnYu5BgI';
            return true;
        }

        async function loadAgendaList() {
            LOADER.style.display = 'flex';
            placeholder.innerHTML = '<p class="placeholder-text">Memuat data...</p>';
            tableBody.innerHTML = "";
            try {
                const res = await hc32_post("listKegiatanAdmin", { token: ADMIN_TOKEN });
                if (res.status === 'ok') {
                    allAgendaData = res.data || [];
                    CURRENT_MEETING_JUDUL = res.currentMeeting || null;
                    renderAgendaTable(); 
                } else throw new Error(res.message);
            } catch (e) {
                console.error(e);
                placeholder.innerHTML = `<p class="placeholder-text" style="color:var(--hc-red)">Error: ${e.message}</p>`;
            } finally {
                LOADER.style.display = 'none';
            }
        }

        function renderAgendaTable() {
            if (!allAgendaData.length) {
                placeholder.style.display = 'block';
                placeholder.innerHTML = '<p class="placeholder-text">Belum ada agenda.</p>';
                tableBody.innerHTML = "";
                return;
            }
            placeholder.style.display = 'none';
            tableBody.innerHTML = "";
            allAgendaData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            allAgendaData.forEach(item => {
                const tr = document.createElement("tr");
                if (item.judul === CURRENT_MEETING_JUDUL) tr.classList.add("current-presensi");
                
                const tgl = new Date(item.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                
                // Logic Waktu (Pisah " - " jika ada)
                let waktuDisplay = item.waktu || '-';
                
                let statusColor = 'var(--hc-dark)';
                if(item.status === 'aktif') statusColor = 'var(--hc-green)';
                if(item.status === 'dibatalkan') statusColor = 'var(--hc-red)';
                
                const isCurrent = item.judul === CURRENT_MEETING_JUDUL;
                const fotoHTML = item.foto ? `<img src="${item.foto}" class="table-foto-preview">` : `<div class="table-foto-placeholder">IMG</div>`;
                
                tr.innerHTML = `
                    <td class="col-foto">${fotoHTML}</td>
                    <td class="col-judul"><span>${item.judul}</span></td>
                    <td class="col-tanggal">${tgl}</td>
                    <td class="col-waktu">${waktuDisplay}</td>
                    <td>${item.tempat || '-'}</td>
                    <td class="col-status" style="color: ${statusColor}">${item.status}</td>
                    <td class="col-aksi">
                        <div class="action-buttons">
                            <button class="btn-action presensi" data-judul="${item.judul}" title="Set Presensi" ${isCurrent?'disabled':''}>${isCurrent?'Aktif':'Set'}</button>
                            <button class="btn-action edit" data-id="${item.id}">Edit</button>
                            <button class="btn-action delete" data-id="${item.id}">Hapus</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (tempatSelect.value === 'custom' && !tempatCustomInput.value.trim()) {
                alert('Isi nama tempat!'); tempatCustomInput.focus(); return;
            }
            const isEditing = !!editIdInput.value;
            if (!confirm(isEditing ? "Simpan perubahan?" : "Simpan agenda baru?")) return;

            LOADER.style.display = 'flex';
            submitBtn.disabled = true; submitBtn.textContent = "Menyimpan...";

            try {
                const formData = new FormData(form);
                const payload = {
                    token: ADMIN_TOKEN,
                    id: formData.get("id"),
                    judul: formData.get("judul"),
                    tanggal: formData.get("tanggal"), 
                    waktuMulai: formData.get("waktuMulai"),
                    waktuSelesai: formData.get("waktuSelesai"),
                    tempat: formData.get("tempat"),
                    tempatCustom: formData.get("tempatCustom"),
                    deskripsi: formData.get("deskripsi"),
                    kategori: formData.get("kategori"),
                    status: formData.get("status"),
                    fotoBase64: selectedFotoBase64 
                };
                const action = isEditing ? "updateKegiatan" : "addKegiatan";
                const res = await hc32_post(action, payload);

                if (res.status === 'ok') {
                    alert("Berhasil!"); resetFormState(); loadAgendaList();
                } else throw new Error(res.message);
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                LOADER.style.display = 'none'; submitBtn.disabled = false;
            }
        }
        
        function populateFormForEdit(id) {
            const item = allAgendaData.find(a => a.id === id);
            if (!item) return;
            
            editIdInput.value = item.id;
            document.getElementById('judul').value = item.judul;
            document.getElementById('tanggal').value = item.tanggal.split('T')[0]; 
            document.getElementById('deskripsi').value = item.deskripsi;
            document.getElementById('kategori').value = item.kategori;
            document.getElementById('status').value = item.status;
            
            // Parse Waktu (format: "13.00 - 15.00" or "13.00 - Selesai")
            // Kita asumsikan pemisah " - "
            const parts = (item.waktu || '').split(' - ');
            waktuMulaiSelect.value = parts[0] ? parts[0].trim() : '';
            waktuSelesaiSelect.value = parts[1] ? parts[1].trim() : '';
            
            if (["Perpustakaan SMAN 32 Jakarta", "Ruang AV SMAN 32 Jakarta", "Saung SMAN 32 Jakarta"].includes(item.tempat)) {
                tempatSelect.value = item.tempat;
                tempatCustomInput.style.display = 'none';
            } else {
                tempatSelect.value = 'custom';
                tempatCustomInput.value = item.tempat;
                tempatCustomInput.style.display = 'block';
            }
            
            if (item.foto) {
                fotoPreview.src = item.foto; fotoPreview.style.display = 'block'; fotoUploadText.style.display = 'none';
            } else {
                fotoPreview.style.display = 'none'; fotoUploadText.style.display = 'block';
            }
            selectedFotoBase64 = null; fotoInput.value = null; 

            formTitle.textContent = "Edit Agenda";
            submitBtn.textContent = "Update Agenda";
            submitBtn.classList.add("editing");
            cancelBtn.style.display = 'inline-block';
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetFormState() {
            form.reset(); editIdInput.value = ""; 
            formTitle.textContent = "Formulir Agenda Baru";
            submitBtn.textContent = "Simpan Agenda Baru";
            submitBtn.classList.remove("editing");
            cancelBtn.style.display = 'none';
            tempatCustomInput.style.display = 'none';
            fotoPreview.style.display = 'none'; fotoPreview.src = '#'; fotoUploadText.style.display = 'block';
            fotoInput.value = null; selectedFotoBase64 = null;
        }

        function handleTableClick(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('edit')) populateFormForEdit(id);
            if (btn.classList.contains('delete') && confirm("Hapus?")) handleDelete(id);
            if (btn.classList.contains('presensi') && confirm("Set Presensi?")) handleSetMeeting(btn.dataset.judul);
        }

        async function handleDelete(id) {
            LOADER.style.display = 'flex';
            try {
                const res = await hc32_post("deleteKegiatan", { token: ADMIN_TOKEN, id });
                if (res.status === 'ok') { alert("Dihapus."); loadAgendaList(); } else throw new Error(res.message);
            } catch(e) { alert(e.message); } finally { LOADER.style.display = 'none'; }
        }
        
        async function handleSetMeeting(judul) {
            LOADER.style.display = 'flex';
            try {
                const res = await hc32_post("setCurrentMeetingFromAgenda", { token: ADMIN_TOKEN, judul });
                if (res.status === 'ok') { alert("Presensi diaktifkan."); loadAgendaList(); } else throw new Error(res.message);
            } catch(e) { alert(e.message); } finally { LOADER.style.display = 'none'; }
        }

        function handleTempatChange() {
            tempatCustomInput.style.display = (tempatSelect.value === 'custom') ? 'block' : 'none';
            if(tempatSelect.value !== 'custom') tempatCustomInput.value = "";
        }
        
        function handleFotoChange(e) {
            const file = e.target.files[0];
            if (!file) { selectedFotoBase64 = null; return; }
            if (file.size/1024/1024 > MAX_FILE_SIZE_MB) { alert("Max 2MB"); fotoInput.value = null; return; }
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedFotoBase64 = ev.target.result;
                fotoPreview.src = ev.target.result; fotoPreview.style.display = 'block'; fotoUploadText.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function generateTimeOptions() {
            let opts = '';
            for (let h = 0; h < 24; h++) {
                for (let m of ['00', '15', '30', '45']) {
                    const t = `${String(h).padStart(2, '0')}.${m}`;
                    opts += `<option value="${t}">${t}</option>`;
                }
            }
            return opts;
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (validateSession()) loadAgendaList();
            
            const tArgs = generateTimeOptions();
            waktuMulaiSelect.innerHTML += tArgs;
            waktuSelesaiSelect.innerHTML += tArgs;
            
            form.addEventListener("submit", handleFormSubmit);
            tableBody.addEventListener("click", handleTableClick);
            cancelBtn.addEventListener("click", resetFormState);
            tempatSelect.addEventListener("change", handleTempatChange);
            fotoInput.addEventListener("change", handleFotoChange);

            document.getElementById("logout-btn").addEventListener("click", (e) => { e.preventDefault(); hc32_logout(); });
            const sb = document.getElementById("sidebar");
            document.getElementById("btn-open-sidebar").addEventListener("click", () => sb.classList.toggle("open"));
        });
    </script>
</body>
</html>
