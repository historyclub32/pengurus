<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pusat Tracking - Admin HC 32</title>

    <script src="../config.js"></script>
    <script src="../components.js"></script>

    <style>
        :root {
            --hc-blue: #1a4787; --hc-toska: #0f8a94; --hc-dark: #2e2e2e;
            --hc-border: #e2e8f0; --hc-bg: #f8fafc; --hc-red: #dc2626;
        }

        /* --- LAYOUT UTAMA --- */
        main { 
            padding: 30px; 
            margin-left: 260px; 
            min-height: 100vh; 
            transition: margin-left 0.3s; 
        }
        @media (max-width: 900px) { main { margin-left: 0; padding: 20px 16px; } }

        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--hc-dark); margin: 0; }

        /* --- TOOLBAR PENCARIAN --- */
        .toolbar { 
            background: #fff; padding: 16px; border-radius: 16px; border: 1px solid var(--hc-border);
            margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .search-wrapper { flex: 1 1 300px; max-width: 100%; position: relative; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-wrapper input { width: 100%; padding: 10px 12px 10px 38px; border: 1px solid #cbd5e1; border-radius: 10px; font-family: inherit; font-size: 14px; outline: none; }
        
        .filter-group { display: flex; gap: 10px; flex: 1 1 auto; max-width: 100%; }
        .filter-select { flex: 1; min-width: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 10px; font-family: inherit; background: #fff; font-size: 13px; outline: none; }

        /* --- TABLE --- */
        .content-card { background: #fff; border-radius: 16px; border: 1px solid var(--hc-border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--hc-border); font-size: 13px; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; }
        .status-pending { background: #eff6ff; color: #1d4ed8; }
        .status-process { background: #fff7ed; color: #c2410c; }
        .status-approved { background: #ecfdf5; color: #047857; }
        .status-rejected { background: #fef2f2; color: #b91c1c; }
        .status-done { background: #f1f5f9; color: #475569; }

        .btn-action { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn-view { background: #f0f9ff; color: var(--hc-blue); }
        .btn-view:hover { background: var(--hc-blue); color: #fff; }

        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            font-size: 13px; 
            border-bottom: 1px solid #f1f5f9; 
            padding: 8px 0; 
        }
        .detail-label { color: #64748b; font-weight: 600; }
        .detail-value { color: #1e293b; font-weight: 700; text-align: right; }

        .tipe-badge { 
            font-size: 10px; 
            font-weight: 700; 
            padding: 2px 8px; 
            border-radius: 4px; 
            color: white; 
        }
        .tipe-siswa { background-color: var(--hc-blue); }
        .tipe-guru { background-color: var(--hc-toska); }
        .tipe-alumni { background-color: #F97316; }
        .tipe-non32 { background-color: var(--hc-dark); }

        /* --- MODAL DETAIL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 15px; }
        .modal-box { background: #fff; border-radius: 20px; width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideIn 0.3s ease; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--hc-border); position: sticky; top: 0; background: #fff; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; }
        
        .control-panel { background: #f8fafc; border-radius: 14px; padding: 18px; margin-bottom: 24px; border: 1px solid var(--hc-border); }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-step { flex: 1; min-width: 140px; padding: 12px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #fff; transition: 0.2s; font-family: inherit; }
        .btn-blue { background: var(--hc-blue); }
        .btn-toska { background: var(--hc-toska); }
        .btn-red { background: var(--hc-red); }

        /* --- TIMELINE --- */
        .timeline { margin-top: 20px; position: relative; padding-left: 20px; }
        .timeline::before { content: ''; position: absolute; left: 5px; top: 5px; bottom: 5px; width: 2px; background: #e2e8f0; }
        .t-item { position: relative; margin-bottom: 20px; }
        .t-dot { position: absolute; left: -20px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; border: 2px solid #fff; box-shadow: 0 0 0 1px #e2e8f0; }
        .t-dot.active { background: var(--hc-toska); box-shadow: 0 0 0 3px rgba(15,138,148,0.2); }
        .t-time { font-size: 11px; color: #94a3b8; font-weight: 600; }
        .t-title { font-size: 13px; font-weight: 700; color: var(--hc-dark); margin: 2px 0; }
        .t-note { font-size: 12px; color: #64748b; line-height: 1.4; }

        @media (max-width: 600px) {
            .toolbar { flex-direction: column; align-items: stretch; }
            .filter-group { flex-direction: column; }
            .modal-header h3 { font-size: 16px; }
            .btn-step { font-size: 13px; padding: 10px; }
        }
    </style>
</head>
<body>

    <main>
        <div class="page-header">
            <h1 class="page-title">Pusat Tracking</h1>
            <p style="color:#64748b; margin:4px 0 0; font-size: 14px;">Manajemen verifikasi permintaan layanan anggota.</p>
        </div>

        <div class="toolbar">
            <div class="search-wrapper">
                <i class="ri-search-line"></i>
                <input type="text" id="inp-search" placeholder="Cari Nama, Kode, atau Email..." onkeyup="filterTable()">
            </div>
            <div class="filter-group">
                <select id="sel-type" class="filter-select" onchange="filterTable()">
                    <option value="">Semua Layanan</option>
                    <option value="PA">Pendaftaran (PA)</option>
                    <option value="PD">Perbaikan (PD)</option>
                    <option value="LS">Support (LS)</option>
                    <option value="AK">Akun (AK)</option>
                </select>
                <select id="sel-status" class="filter-select" onchange="filterTable()">
                    <option value="">Semua Status</option>
                    <option value="Permintaan Terkirim">Permintaan Terkirim</option>
                    <option value="Menunggu Verifikasi">Menunggu Verifikasi</option>
                    <option value="Dalam Proses Verifikasi">Dalam Proses Verifikasi</option>
                    <option value="Disetujui">Disetujui</option>
                    <option value="Ditolak">Ditolak</option>
                    <option value="Selesai">Selesai</option>
                </select>
            </div>
        </div>

        <div class="content-card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Kode & Tanggal</th>
                            <th>Pemohon</th>
                            <th>Layanan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="5" style="text-align:center; padding:40px; color:#94a3b8;">
                            <i class="ri-loader-4-line ri-spin" style="font-size: 24px;"></i><br>Menghubungkan ke database...
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modal-detail" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <h3 id="md-code" style="margin:0; font-weight:800; color: var(--hc-blue);">PA000000</h3>
                    <span id="md-date" style="font-size:11px; color:#94a3b8; font-weight: 600;">-</span>
                </div>
                <button class="btn-action btn-view" onclick="closeModal()" style="padding: 6px;"><i class="ri-close-line" style="font-size:22px;"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:24px; background: #f1f5f9; padding: 15px; border-radius: 12px;">
                    <div>
                        <label style="font-size:10px; font-weight:800; color:#94a3b8; text-transform:uppercase;">Pemohon</label>
                        <div id="md-name" style="font-weight:700; color:var(--hc-dark); font-size: 14px;">...</div>
                    </div>
                    <div>
                        <label style="font-size:10px; font-weight:800; color:#94a3b8; text-transform:uppercase;">Kontak</label>
                        <div id="md-contact" style="font-weight:600; color:#64748b; font-size: 13px;">...</div>
                    </div>
                </div>

                <div id="md-custom-details"></div>

                <div class="control-panel">
                    <label style="font-weight:800; font-size:11px; color:var(--hc-blue); display:flex; align-items:center; gap:6px;">
                        <i class="ri-shield-user-line"></i> PANEL KONTROL PENGURUS
                    </label>
                    <div id="md-actions" class="btn-group"></div>
                </div>

                <label style="font-weight:800; font-size:11px; color:#1e293b; display:flex; align-items:center; gap:6px; margin-bottom:15px; text-transform: uppercase;">
                    <i class="ri-history-line"></i> Log Riwayat Proses
                </label>
                <div id="md-timeline" class="timeline"></div>
            </div>
        </div>
    </div>

    <div id="modal-reject" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="margin:0; font-size:18px; color:var(--hc-red);"><i class="ri-error-warning-line"></i> Tolak & Minta Perbaikan</h3>
                <button class="btn-action" onclick="closeRejectModal()" title="Tutup"><i class="ri-close-line" style="font-size:20px;"></i></button>
            </div>
            <div class="modal-body">
                <p style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
                    Centang kolom yang datanya **salah/tidak valid**. Pemohon akan diminta memperbaiki bagian tersebut.
                </p>
                
                <div id="dynamic-reject-fields" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                </div>

                <label style="font-weight:700; font-size:12px; color:var(--hc-dark); display:block; margin-bottom:8px;">INSTRUKSI TAMBAHAN (WAJIB):</label>
                <textarea id="reject-reason" style="width:100%; height:80px; padding:12px; border:1px solid #cbd5e1; border-radius:10px; font-family:inherit; font-size:13px; resize:none; outline:none;" placeholder="Berikan instruksi jelas apa yang harus diperbaiki..."></textarea>
                
                <div class="btn-group" style="margin-top:20px;">
                    <button class="btn-step btn-red" id="btn-confirm-reject" onclick="executeReject()">Kirim Penolakan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ADMIN_TOKEN = null;
        let MASTER_DATA = [];
        let pendingRejectCode = null;
        let currentDetailedData = null;

        const FIELD_LABELS = {
            "nama": "Nama Lengkap",
            "nis": "Nomor Identitas (NIS/NIP)",
            "kelas": "Data Kelas",
            "angkatan": "Tahun Angkatan",
            "email": "Alamat Email",
            "nohp": "Nomor WhatsApp",
            "tanggalLahir": "Tanggal Lahir",
            "foto": "Foto Profil",
            "tandaTanganURL": "Tanda Tangan",
            "jabatan": "Jabatan/Keterangan",
            "tahunLulus": "Tahun Kelulusan"
        };

        document.addEventListener("DOMContentLoaded", () => {
            initHC32AdminNavigation('tracking');
            if (cekSesi()) {
                loadRequests();
            }
        });

        function cekSesi() {
            const session = hc32_getSession();
            if (!session || !session.token) {
                window.location.href = "../../keanggotaan/login pengurus/index.html";
                return false;
            }
            ADMIN_TOKEN = session.token;
            return true;
        }

        async function loadRequests() {
            if (window.showHC32Status) window.showHC32Status('loading', 'Sinkronisasi...', 'Mengambil data permintaan terbaru.');
            try {
                const res = await hc32_post("listRequests", { token: ADMIN_TOKEN });
                if (window.hideHC32Status) window.hideHC32Status();
                
                if (res.status === 'ok') {
                    MASTER_DATA = res.data;
                    renderTable(MASTER_DATA);
                } else {
                    document.getElementById('table-body').innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#ef4444;">${res.message}</td></tr>`;
                }
            } catch (e) {
                if (window.showHC32Status) window.showHC32Status('error', 'Gagal', 'Terjadi kesalahan jaringan.');
            }
        }

        function renderTable(data) {
            const body = document.getElementById('table-body');
            if (!data || data.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#94a3b8;">Belum ada permintaan di sistem.</td></tr>`;
                return;
            }

            body.innerHTML = data.map(r => {
                const s = r.Status;
                let badgeCls = 'status-pending';
                if (s === 'Selesai') badgeCls = 'status-done';
                else if (s === 'Disetujui') badgeCls = 'status-approved';
                else if (s === 'Ditolak') badgeCls = 'status-rejected';
                else if (s.includes('Proses') || s.includes('Verifikasi')) badgeCls = 'status-process';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight:700; color:var(--hc-blue);">${r.RequestCode}</div>
                            <div style="font-size:11px; color:#94a3b8; margin-top:2px;">${formatDateTimeIndo(r.CreatedAt)}</div>
                        </td>
                        <td>
                            <div style="font-weight:600; font-size: 14px;">${r.OwnerName}</div>
                            <div style="font-size:11px; color:#64748b;">${r.OwnerEmail}</div>
                        </td>
                        <td><span style="font-weight:600;">${mapPrefix(r.RequestType)}</span></td>
                        <td><span class="status-badge ${badgeCls}">${s}</span></td>
                        <td>
                            <button class="btn-action btn-view" onclick="viewDetail('${r.RequestCode}')">
                                <i class="ri-settings-line"></i> Kelola
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function mapPrefix(p) {
            const map = { 'PA': 'Pendaftaran', 'PD': 'Perbaikan', 'LS': 'Support', 'AK': 'Akun' };
            return map[p] || p;
        }

        function filterTable() {
            const q = document.getElementById('inp-search').value.toLowerCase();
            const type = document.getElementById('sel-type').value;
            const status = document.getElementById('sel-status').value;

            const filtered = MASTER_DATA.filter(r => {
                const matchQ = r.RequestCode.toLowerCase().includes(q) || r.OwnerName.toLowerCase().includes(q) || r.OwnerEmail.toLowerCase().includes(q);
                const matchT = type === "" || r.RequestType === type;
                const matchS = status === "" || r.Status === status;
                return matchQ && matchT && matchS;
            });
            renderTable(filtered);
        }

        async function viewDetail(code) {
            if (window.showHC32Status) window.showHC32Status('loading', 'Memproses...', 'Membuka rincian data.');
            try {
                const res = await hc32_post("trackRequest", { 
                    trackingCode: code, 
                    secret: "ADMIN_BYPASS", 
                    token: ADMIN_TOKEN 
                });

                if (window.hideHC32Status) window.hideHC32Status();

                if (res.status === 'ok') {
                    currentDetailedData = res.request.detailedData; 
                    renderModal(res);
                } else {
                    if (window.showHC32Status) window.showHC32Status('error', 'Gagal', res.message);
                }
            } catch (e) {
                if (window.hideHC32Status) window.hideHC32Status();
            }
        }

        function renderModal(res) {
            const r = res.request;
            const events = res.events || [];
            const prefix = (r.code || '').substring(0, 2).toUpperCase();

            document.getElementById('md-code').innerText = r.code;
            document.getElementById('md-date').innerText = "Dibuat: " + formatDateTimeIndo(r.createdAt);
            document.getElementById('md-name').innerText = r.ownerName;
            
            const emailHeader = r.ownerEmail || "-";
            const phoneHeader = r.detailedData ? ` â€¢ ${r.detailedData.nohp}` : '';
            document.getElementById('md-contact').innerText = emailHeader + phoneHeader;
            
            renderActionButtons(r.status, r.code);

            let detailsHTML = '';
            if (r.detailedData) {
                const d = r.detailedData;
                const tipe = (d.tipe || 'siswa-aktif').toLowerCase();
                const tipeInfo = formatTipe(tipe);

                let idLabel = "ID Anggota";
                let idValue = d.nis || "-";
                if (tipe === 'guru') { idLabel = "NIP (18 Digit)"; idValue = d.nip || "-"; }
                else if (tipe === 'alumni') { idLabel = "No. Anggota Perpus 32"; idValue = d.nis || "-"; }
                else if (tipe === 'siswa-aktif') { idLabel = "NIS (7 Digit)"; idValue = d.nis || "-"; }

                detailsHTML = `
                    <div style="font-weight:800; font-size:11px; color:var(--hc-blue); margin-bottom:10px; text-transform: uppercase;">
                        <i class="ri-file-user-line"></i> Rincian Data Permintaan
                    </div>
                    <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                             <span class="tipe-badge ${tipeInfo.className}" style="border: 1px solid rgba(0,0,0,0.1); padding: 4px 10px;">
                                 ${tipeInfo.text.toUpperCase()}
                             </span>
                        </div>
                        <div class="detail-row"><span class="detail-label">Nama Lengkap</span><span class="detail-value">${d.nama || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">${idLabel}</span><span class="detail-value">${idValue}</span></div>
                        <div class="detail-row"><span class="detail-label">Kelas / Keterangan</span><span class="detail-value">${d.kelas || d.jabatan || "-"}</span></div>
                        <div class="detail-row"><span class="detail-label">Email Aktif</span><span class="detail-value">${d.email || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Nomor WhatsApp</span><span class="detail-value">${d.nohp || '-'}</span></div>
                        <div class="detail-row" style="border-bottom:none;"><span class="detail-label">Tanggal Lahir</span><span class="detail-value">${d.tanggalLahir || '-'}</span></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="width:100%; aspect-ratio: 1/1; overflow:hidden; border-radius:8px; border:1px solid #e2e8f0; background:#f8fafc; display:flex; align-items:center; justify-content:center;">
                                    <img src="${d.foto || 'https://placehold.co/200?text=No+Photo'}" 
                                         style="width:100%; height:100%; object-fit:cover;"
                                         onerror="this.src='https://placehold.co/200?text=Error+Load'">
                                </div>
                                <div style="font-size:10px; font-weight:800; color:var(--hc-blue); margin-top:6px;">FOTO PROFIL</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width:100%; aspect-ratio: 1/1; overflow:hidden; border-radius:8px; border:1px solid #e2e8f0; background:#fff; display:flex; align-items:center; justify-content:center; padding: 5px;">
                                    <img src="${d.tandaTanganURL || 'https://placehold.co/200?text=No+Sign'}" 
                                         style="max-width:100%; max-height:100%; object-fit:contain;"
                                         onerror="this.src='https://placehold.co/200?text=Error+Load'">
                                </div>
                                <div style="font-size:10px; font-weight:800; color:var(--hc-blue); margin-top:6px;">TANDA TANGAN</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('md-custom-details').innerHTML = detailsHTML;

            const timeline = document.getElementById('md-timeline');
            timeline.innerHTML = events.reverse().map((ev, i) => `
                <div class="t-item">
                    <div class="t-dot ${i === 0 ? 'active' : ''}"></div>
                    <div class="t-time">${formatDateTimeIndo(ev.at)}</div>
                    <div class="t-title">${ev.type === 'created' ? 'Request Dibuat' : (ev.toStatus || 'Pembaruan Status')}</div>
                    <div class="t-note">${ev.note || 'Tercatat di sistem.'}</div>
                </div>
            `).join('');

            document.getElementById('modal-detail').style.display = 'flex';
        }

        function formatTipe(tipe) {
            switch(tipe) {
                case 'siswa-aktif': return { text: 'Siswa Aktif', className: 'tipe-siswa' };
                case 'guru': return { text: 'Guru / Karyawan', className: 'tipe-guru' };
                case 'alumni': return { text: 'Alumni SMAN 32', className: 'tipe-alumni' };
                default: return { text: 'Umum / Non-32', className: 'tipe-non32' };
            }
        }

        function renderActionButtons(status, code) {
            const box = document.getElementById('md-actions');
            let html = '';

            if (status === 'Permintaan Terkirim') {
                html = `<button class="btn-step btn-blue" onclick="updateStatus('${code}', 'Menunggu Verifikasi')">Terima & Masukkan Antrean</button>`;
            } else if (status === 'Menunggu Verifikasi') {
                html = `<button class="btn-step btn-blue" onclick="updateStatus('${code}', 'Dalam Proses Verifikasi')">Mulai Periksa Data</button>`;
            } else if (status === 'Dalam Proses Verifikasi') {
                html = `
                    <button class="btn-step btn-toska" onclick="updateStatus('${code}', 'Disetujui')">Setujui</button>
                    <button class="btn-step btn-red" onclick="rejectWithNote('${code}')">Tolak & Minta Perbaikan</button>
                `;
            } else if (status === 'Disetujui' || status === 'Ditolak') {
                html = `<button class="btn-step btn-blue" onclick="updateStatus('${code}', 'Selesai')">Selesaikan Request</button>`;
            } else {
                html = `<div style="color:#94a3b8; font-size:12px; font-weight:600; text-align:center; width:100%;">Proses Selesai</div>`;
            }

            box.innerHTML = html;
        }

        // --- REJECT LOGIC ---
        function rejectWithNote(code) {
            pendingRejectCode = code;
            const container = document.getElementById('dynamic-reject-fields');
            container.innerHTML = '';
            
            if (currentDetailedData) {
                Object.keys(currentDetailedData).forEach(key => {
                    if (['id_hc', 'tipe'].includes(key) || !currentDetailedData[key]) return;

                    const label = FIELD_LABELS[key] || key;
                    const div = document.createElement('label');
                    div.style = "display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer; background:white; padding:6px 10px; border-radius:6px; border:1px solid #e2e8f0;";
                    div.innerHTML = `<input type="checkbox" value="${label}" class="reject-chk"> <span>${label}</span>`;
                    container.appendChild(div);
                });
            }

            document.getElementById('reject-reason').value = '';
            document.getElementById('modal-reject').style.display = 'flex';
        }

        function closeRejectModal() {
            document.getElementById('modal-reject').style.display = 'none';
            pendingRejectCode = null;
        }

        async function executeReject() {
            const reasonText = document.getElementById('reject-reason').value.trim();
            const selectedFields = [];
            document.querySelectorAll('.reject-chk:checked').forEach(chk => selectedFields.push(chk.value));

            if (reasonText === "") {
                if (window.showHC32Status) window.showHC32Status('error', 'Input Kosong', 'Harap isi instruksi perbaikan.');
                return;
            }

            let finalNote = "";
            if (selectedFields.length > 0) {
                finalNote = "Perbaikan diperlukan pada: " + selectedFields.join(", ") + ". \nCatatan: " + reasonText;
            } else {
                finalNote = reasonText;
            }

            await updateStatus(pendingRejectCode, 'Ditolak', finalNote);
            closeRejectModal();
            closeModal();
        }

        async function updateStatus(code, nextStatus, note = "") {
            if (window.showHC32Status) window.showHC32Status('loading', 'Memproses...', 'Menyimpan perubahan status.');
            try {
                const res = await hc32_post("adminUpdateRequestStatus", {
                    token: ADMIN_TOKEN, 
                    trackingCode: code, 
                    nextStatus: nextStatus, 
                    note: note
                });

                if (res.status === 'ok') {
                    if (window.hideHC32Status) window.hideHC32Status();
                    loadRequests(); 
                    if (window.showHC32Status) window.showHC32Status('success', 'Berhasil', `Status diperbarui ke ${nextStatus}`);
                } else {
                    if (window.showHC32Status) window.showHC32Status('error', 'Gagal', res.message);
                }
            } catch (e) {
                if (window.hideHC32Status) window.hideHC32Status();
                if (window.showHC32Status) window.showHC32Status('error', 'Server Error', 'Gagal terhubung ke database.');
            }
        }

        function closeModal() { document.getElementById('modal-detail').style.display = 'none'; }

        function formatDateTimeIndo(dateTimeStr) {
            if (!dateTimeStr) return "-";
            const d = new Date(dateTimeStr);
            if (isNaN(d)) return dateTimeStr; 
            return d.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }) + ' ' + d.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            }).replace('.', ':');
        }
    </script>
</body>
</html>
